<!-- pages/downloads/downloads.wxml -->
<view class="page-container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="header-content">
      <text class="page-title">æˆ‘çš„ä¸‹è½½</text>
      <text class="page-subtitle">å…± {{stats.total}} ä¸ªæ–‡ä»¶ ({{formatFileSize(stats.totalSize)}})</text>
    </view>
    
    <!-- å¿«æ·æ“ä½œæŒ‰é’® -->
    <view class="header-actions">
      <view class="action-btn" bindtap="toggleFilter">
        <text class="action-icon">ğŸ”</text>
      </view>
      <view class="action-btn" bindtap="toggleSelectMode">
        <text class="action-icon">{{isSelectMode ? 'âœ…' : 'â˜‘ï¸'}}</text>
      </view>
    </view>
  </view>

  <!-- æœç´¢æ  -->
  <view class="search-section">
    <view class="search-box">
      <view class="search-input-wrapper">
        <input
          class="search-input"
          type="text"
          placeholder="æœç´¢ä¸‹è½½å†…å®¹..."
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
          confirm-type="search"
        />
        <view wx:if="{{searchKeyword}}" class="search-clear" bindtap="clearSearch">
          <text class="clear-icon">Ã—</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰é¢æ¿ -->
  <view wx:if="{{showFilter}}" class="filter-panel">
    <view class="filter-overlay" bindtap="toggleFilter"></view>
    <view class="filter-content">
      <view class="filter-header">
        <text class="filter-title">ç­›é€‰çŠ¶æ€</text>
        <view class="filter-close" bindtap="toggleFilter">Ã—</view>
      </view>
      <view class="filter-options">
        <view 
          wx:for="{{statusOptions}}" 
          wx:key="value"
          class="filter-option {{filterStatus === item.value ? 'active' : ''}}"
          data-status="{{item.value}}"
          bindtap="selectFilterStatus"
        >
          <text class="option-icon">{{item.icon}}</text>
          <text class="option-label">{{item.label}}</text>
        </view>
      </view>
      
      <!-- å¿«æ·æ“ä½œ -->
      <view class="filter-actions">
        <button class="action-button secondary" bindtap="onClearFailed">
          æ¸…ç†å¤±è´¥é¡¹ç›®
        </button>
      </view>
    </view>
  </view>

  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <view wx:if="{{!isEmpty && !loading}}" class="stats-section">
    <view class="stats-grid">
      <view class="stat-item success">
        <text class="stat-number">{{stats.downloaded}}</text>
        <text class="stat-label">å·²ä¸‹è½½</text>
      </view>
      <view class="stat-item warning">
        <text class="stat-number">{{stats.downloading}}</text>
        <text class="stat-label">ä¸‹è½½ä¸­</text>
      </view>
      <view class="stat-item error">
        <text class="stat-number">{{stats.failed}}</text>
        <text class="stat-label">å¤±è´¥</text>
      </view>
    </view>
  </view>

  <!-- æ‰¹é‡æ“ä½œæ  -->
  <view wx:if="{{isSelectMode}}" class="batch-actions">
    <view class="batch-left">
      <view class="select-all" bindtap="onSelectAll">
        <text class="select-icon">{{selectAll ? 'â˜‘ï¸' : 'â˜'}}</text>
        <text class="select-text">å…¨é€‰</text>
      </view>
      <text class="selected-count">å·²é€‰ {{selectedItems.length}} é¡¹</text>
    </view>
    <view class="batch-right">
      <button class="batch-btn delete" bindtap="onBatchDelete">åˆ é™¤</button>
    </view>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <view class="content-section">
    <!-- åŠ è½½ä¸­ -->
    <view wx:if="{{loading}}" class="loading-container">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:elif="{{isEmpty}}" class="empty-container">
      <view class="empty-icon">ğŸ“¥</view>
      <text class="empty-title">è¿˜æ²¡æœ‰ä¸‹è½½</text>
      <text class="empty-subtitle">åœ¨æ’­æ”¾é¡µé¢é•¿æŒ‰å¯ä»¥ä¸‹è½½éŸ³é¢‘åˆ°æœ¬åœ°</text>
      <button class="btn-explore" bindtap="onExplore">å»æ¢ç´¢</button>
    </view>

    <!-- ä¸‹è½½åˆ—è¡¨ -->
    <view wx:else class="downloads-list">
      <view 
        wx:for="{{filteredDownloads}}" 
        wx:key="id"
        class="download-item {{isSelectMode ? 'select-mode' : ''}} {{item.status}}"
        data-item="{{item}}"
        bindtap="onItemTap"
      >
        <!-- é€‰æ‹©æ¡† -->
        <view wx:if="{{isSelectMode}}" class="item-selector" data-id="{{item.id}}" catchtap="onSelectItem">
          <text class="selector-icon">{{selectedItemsMap[item.id] ? 'â˜‘ï¸' : 'â˜'}}</text>
        </view>

        <view class="item-cover">
          <image class="cover-image" src="{{item.cover}}" mode="aspectFill" />
          <view class="status-overlay">
            <text class="status-icon">
              {{item.status === 'downloaded' ? 'âœ…' : 
                (item.status === 'downloading' ? 'â¬' : 
                (item.status === 'failed' ? 'âŒ' : 'ğŸ“'))}}
            </text>
          </view>
          
          <!-- ä¸‹è½½è¿›åº¦æ¡ -->
          <view wx:if="{{item.status === 'downloading'}}" class="progress-overlay">
            <view class="progress-bar">
              <view class="progress-fill" style="width: {{item.progress}}%"></view>
            </view>
            <text class="progress-text">{{item.progress}}%</text>
          </view>
        </view>

        <view class="item-content">
          <view class="item-main">
            <text class="item-title">{{item.title}}</text>
            <text class="item-subtitle">{{item.subtitle}}</text>
          </view>
          
          <view class="item-meta">
            <view class="meta-row">
              <text class="file-size">{{formatFileSize(item.fileSize)}}</text>
              <text wx:if="{{item.duration}}" class="item-duration">
                {{formatDuration(item.duration)}}
              </text>
            </view>
            <view class="meta-row">
              <text class="download-time">{{formatDownloadTime(item.downloadTime)}}</text>
              <text class="status-text {{item.status}}">
                {{item.status === 'downloaded' ? 'å·²å®Œæˆ' : 
                  (item.status === 'downloading' ? 'ä¸‹è½½ä¸­' : 
                  (item.status === 'failed' ? 'å¤±è´¥' : 'æœªçŸ¥'))}}
              </text>
            </view>
            <view wx:if="{{item.error}}" class="error-message">
              <text class="error-text">é”™è¯¯: {{item.error}}</text>
            </view>
          </view>
        </view>

        <!-- æ“ä½œæŒ‰é’® -->
        <view wx:if="{{!isSelectMode}}" class="item-actions">
          <view 
            wx:if="{{item.status === 'failed'}}"
            class="action-btn retry-btn"
            data-item="{{item}}"
            catchtap="retryDownload"
          >
            <text class="action-icon">ğŸ”„</text>
          </view>
          <view 
            class="action-btn delete-btn"
            data-item="{{item}}"
            catchtap="onDeleteItem"
          >
            <text class="action-icon">ğŸ—‘ï¸</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰ç»“æœæç¤º -->
  <view wx:if="{{filteredDownloads.length < downloads.length && !loading}}" class="filter-tip">
    <text class="tip-text">
      æ˜¾ç¤º {{filteredDownloads.length}} / {{downloads.length}} é¡¹
      {{searchKeyword ? 'åŒ…å«"' + searchKeyword + '"çš„' : ''}}
      {{filterStatus !== 'all' ? statusLabelMap[filterStatus] : ''}}
      ä¸‹è½½
    </text>
  </view>
</view>
