<view class="container">
  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-wrapper">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 订单内容 -->
  <view wx:else class="order-content">
    <!-- 收货地址 -->
    <view class="section address-section">
      <view class="section-header" bindtap="showAddressSelector">
        <view class="address-info">
          <view wx:if="{{selectedAddress}}" class="address-content">
            <view class="address-user">
              <text class="user-name">{{selectedAddress.name}}</text>
              <text class="user-phone">{{selectedAddress.phone}}</text>
              <text wx:if="{{selectedAddress.isDefault}}" class="default-tag">默认</text>
            </view>
            <view class="address-detail">
              {{selectedAddress.province}} {{selectedAddress.city}} {{selectedAddress.district}} {{selectedAddress.detail}}
            </view>
          </view>
          <view wx:else class="no-address">
            <text class="iconfont icon-location"></text>
            <text>请选择收货地址</text>
          </view>
        </view>
        <text class="iconfont icon-arrow-right"></text>
      </view>
    </view>

    <!-- 配送方式 -->
    <view class="section delivery-section">
      <view class="section-title">配送方式</view>
      <view class="delivery-methods">
        <view 
          class="delivery-method {{selectedDeliveryMethod === item.id ? 'selected' : ''}}"
          wx:for="{{deliveryMethods}}" 
          wx:key="id"
          data-id="{{item.id}}"
          bindtap="selectDeliveryMethod"
        >
          <view class="method-info">
            <view class="method-name">{{item.name}}</view>
            <view class="method-description">{{item.description}}</view>
          </view>
          <view class="method-fee">
            {{item.fee > 0 ? '¥' + item.fee : '免费'}}
          </view>
          <view class="method-radio">
            <view class="radio {{selectedDeliveryMethod === item.id ? 'checked' : ''}}"></view>
          </view>
        </view>
      </view>
    </view>

    <!-- 商品信息 -->
    <view class="section product-section">
      <view class="section-title">商品信息</view>
      <view class="product-item">
        <image 
          class="product-image" 
          src="{{productInfo.images && productInfo.images.length ? productInfo.images[0] : '/images/default-image.png'}}" 
        />
        <view class="product-info">
          <view class="product-name">{{productInfo.name}}</view>
          <view class="product-specs">
            <text wx:for="{{productInfo.selectedSpecs}}" wx:for-item="value" wx:for-index="name" wx:key="name">
              {{value}}
            </text>
          </view>
          <view class="product-bottom">
            <view class="product-price">¥{{productInfo.displayPrice}}</view>
            <view class="product-quantity">x{{productInfo.quantity}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- 优惠券 -->
    <view class="section coupon-section">
      <view class="section-header" bindtap="showCouponSelector">
        <view class="coupon-info">
          <text class="iconfont icon-coupon"></text>
          <text wx:if="{{selectedCoupon}}" class="coupon-selected">
            已选择：{{selectedCoupon.name}}
          </text>
          <text wx:else class="coupon-placeholder">选择优惠券</text>
        </view>
        <view class="coupon-action">
          <text wx:if="{{availableCoupons.length > 0}}" class="available-count">
            {{availableCoupons.length}}张可用
          </text>
          <text class="iconfont icon-arrow-right"></text>
        </view>
      </view>
    </view>

    <!-- 支付方式 -->
    <view class="section payment-section">
      <view class="section-title">支付方式</view>
      <view class="payment-methods">
        <view 
          class="payment-method {{selectedPaymentMethod === item.id ? 'selected' : ''}}"
          wx:for="{{paymentMethods}}" 
          wx:key="id"
          data-id="{{item.id}}"
          bindtap="selectPaymentMethod"
        >
          <view class="method-icon">
            <image class="payment-icon" src="{{item.icon}}" />
          </view>
          <view class="method-name">{{item.name}}</view>
          <view class="method-radio">
            <view class="radio {{selectedPaymentMethod === item.id ? 'checked' : ''}}"></view>
          </view>
        </view>
      </view>
    </view>

    <!-- 备注 -->
    <view class="section note-section">
      <view class="section-title">订单备注</view>
      <textarea 
        class="note-input" 
        placeholder="选填，给商家留言..."
        value="{{orderNote}}"
        bindinput="onNoteInput"
        maxlength="200"
      />
    </view>

    <!-- 价格明细 -->
    <view class="section price-section">
      <view class="price-item">
        <text class="price-label">商品总价</text>
        <text class="price-value">¥{{displayProductTotal}}</text>
      </view>
      <view class="price-item">
        <text class="price-label">配送费</text>
        <text class="price-value">{{deliveryTotal > 0 ? '¥' + displayDeliveryTotal : '免费'}}</text>
      </view>
      <view wx:if="{{discountTotal > 0}}" class="price-item discount">
        <text class="price-label">优惠金额</text>
        <text class="price-value">-¥{{displayDiscountTotal}}</text>
      </view>
      <view class="price-item total">
        <text class="price-label">应付金额</text>
        <text class="price-value">¥{{displayFinalTotal}}</text>
      </view>
    </view>

    <!-- 底部占位 -->
    <view class="bottom-placeholder"></view>
  </view>
</view>

<!-- 底部提交栏 -->
<view class="bottom-submit">
  <view class="submit-info">
    <view class="total-amount">
      <text class="total-label">合计：</text>
      <text class="total-price">¥{{displayFinalTotal}}</text>
    </view>
  </view>
  <button 
    class="submit-btn {{isSubmitting ? 'loading' : ''}}" 
    bindtap="submitOrder"
    disabled="{{isSubmitting}}"
  >
    {{isSubmitting ? '提交中...' : '立即支付'}}
  </button>
</view>

<!-- 地址选择弹窗 -->
<view class="address-modal {{showAddressSelector ? 'show' : ''}}" bindtap="hideAddressSelector">
  <view class="address-panel" catchtap="">
    <view class="modal-header">
      <text class="modal-title">选择收货地址</text>
      <view class="modal-close" bindtap="hideAddressSelector">
        <text class="iconfont icon-close"></text>
      </view>
    </view>
    
    <view class="address-list">
      <view 
        class="address-item {{selectedAddress && selectedAddress.id === item.id ? 'selected' : ''}}"
        wx:for="{{addressList}}" 
        wx:key="id"
        data-id="{{item.id}}"
        bindtap="selectAddress"
      >
        <view class="address-main">
          <view class="address-user">
            <text class="user-name">{{item.name}}</text>
            <text class="user-phone">{{item.phone}}</text>
            <text wx:if="{{item.isDefault}}" class="default-tag">默认</text>
          </view>
          <view class="address-detail">
            {{item.province}} {{item.city}} {{item.district}} {{item.detail}}
          </view>
        </view>
        <view class="address-radio">
          <view class="radio {{selectedAddress && selectedAddress.id === item.id ? 'checked' : ''}}"></view>
        </view>
      </view>
      
      <!-- 添加新地址 -->
      <view class="add-address-btn" bindtap="addNewAddress">
        <text class="iconfont icon-plus"></text>
        <text>添加新地址</text>
      </view>
    </view>
  </view>
</view>

<!-- 优惠券选择弹窗 -->
<view class="coupon-modal {{showCouponSelector ? 'show' : ''}}" bindtap="hideCouponSelector">
  <view class="coupon-panel" catchtap="">
    <view class="modal-header">
      <text class="modal-title">选择优惠券</text>
      <view class="modal-close" bindtap="hideCouponSelector">
        <text class="iconfont icon-close"></text>
      </view>
    </view>
    
    <view class="coupon-list">
      <view 
        class="coupon-item {{selectedCoupon && selectedCoupon.id === item.id ? 'selected' : ''}}"
        wx:for="{{availableCoupons}}" 
        wx:key="id"
        data-id="{{item.id}}"
        bindtap="selectCoupon"
      >
        <view class="coupon-amount">
          <text class="amount-value">{{item.displayDiscount}}</text>
        </view>
        <view class="coupon-info">
          <view class="coupon-name">{{item.name}}</view>
          <view class="coupon-condition">
            <text wx:if="{{item.minAmount > 0}}">满{{item.minAmount}}元可用</text>
            <text wx:else>无门槛</text>
          </view>
          <view wx:if="{{item.description}}" class="coupon-description">{{item.description}}</view>
        </view>
        <view class="coupon-radio">
          <view class="radio {{selectedCoupon && selectedCoupon.id === item.id ? 'checked' : ''}}"></view>
        </view>
      </view>
      
      <!-- 不使用优惠券 -->
      <view class="no-coupon-option" data-id="" bindtap="selectCoupon">
        <text>不使用优惠券</text>
        <view class="coupon-radio">
          <view class="radio {{!selectedCoupon ? 'checked' : ''}}"></view>
        </view>
      </view>
    </view>
  </view>
</view>
