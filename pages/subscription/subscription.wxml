<!--pages/subscription/subscription.wxml-->
<view class="container">
  <!-- 当前订阅状态 -->
  <view class="subscription-status" wx:if="{{subscriptionInfo}}">
    <view class="status-content">
      <!-- 订阅中状态 -->
      <view class="status-title" wx:if="{{subscriptionInfo.is_subscribed}}">
        <text class="status-icon">✅</text> 已订阅
      </view>
      
      <!-- 试用中状态 -->
      <view class="status-title" wx:elif="{{isInTrial}}">
        <text class="status-icon">🎵</text> 试用中
      </view>
      
      <!-- 试用已结束状态 -->
      <view class="status-title" wx:elif="{{subscriptionInfo.trial_end_date && !subscriptionInfo.trial_available}}">
        <text class="status-icon">⏰</text> 试用已结束
      </view>
      
      <!-- 需要登录状态 -->
      <view class="status-title" wx:elif="{{subscriptionInfo.requires_login}}">
        <text class="status-icon">🔐</text> 需要登录
      </view>
      
      <!-- 获取信息错误状态 -->
      <view class="status-title" wx:elif="{{subscriptionInfo.error}}">
        <text class="status-icon">❌</text> 获取状态失败
      </view>
      
      <!-- 未订阅状态 -->
      <view class="status-title" wx:else>
        <text class="status-icon">📱</text> 未订阅
      </view>
      
      <!-- 状态描述 -->
      <view class="status-desc" wx:if="{{subscriptionInfo.is_subscribed}}">
        {{subscriptionInfo.type === 'premium' ? '高级版' : subscriptionInfo.type === 'vip' ? 'VIP版' : '标准版'}}
      </view>
      <view class="status-desc" wx:elif="{{isInTrial}}">
        7天免费试用期，可体验所有高级功能，还剩{{trialDaysLeft}}天
      </view>
      <view class="status-desc" wx:elif="{{subscriptionInfo.trial_end_date && !subscriptionInfo.trial_available}}">
        试用期已结束，当前使用免费版功能
      </view>
      <view class="status-desc" wx:elif="{{subscriptionInfo.requires_login}}">
        请先登录以查看和管理您的订阅状态
      </view>
      <view class="status-desc" wx:elif="{{subscriptionInfo.error}}">
        {{subscriptionInfo.error}}，请稍后重试或联系客服
      </view>
      <view class="status-desc" wx:else>
        当前使用免费版，功能受限
      </view>
      
      <!-- 到期时间 -->
      <view class="status-info" wx:if="{{subscriptionInfo.subscription_end_date}}">
        订阅到期：{{subscriptionInfo.subscription_end_date}}
        <text wx:if="{{subscriptionInfo.days_left}}">（剩余{{subscriptionInfo.days_left}}天）</text>
      </view>
      <view class="status-info" wx:elif="{{subscriptionInfo.trial_end_date && subscriptionInfo.status === 'active'}}">
        试用到期：{{subscriptionInfo.trial_end_date}}
      </view>
    </view>
  </view>

  <!-- 免费试用区域 -->
  <!-- 正在试用中 -->
  <view class="trial-card trial-active" wx:if="{{isInTrial}}">
    <view class="trial-content">
      <view class="trial-title">🎵 试用中</view>
      <view class="trial-desc">
        您正在免费试用高级功能，还剩<text class="highlight">{{trialDaysLeft}}</text>天
        <view class="trial-features">
          ✅ 无限制AI音乐生成
          ✅ 长序列音乐播放
          ✅ 高品质音频下载
        </view>
      </view>
      <view class="trial-expire-info">
        试用到期后将恢复免费版功能
      </view>
    </view>
  </view>
  
  <!-- 可以开始试用 -->
  <view class="trial-card" wx:elif="{{showTrialOption}}">
    <view class="trial-content">
      <view class="trial-title">🎵 免费试用7天</view>
      <view class="trial-desc">
        立即开始免费试用，体验所有高级功能：
        · 无限制AI音乐生成
        · 长序列音乐播放
        · 高品质音频下载
      </view>
      <view class="trial-btn" bind:tap="onStartTrial">
        {{purchasing ? '开始中...' : '立即开始试用'}}
      </view>
    </view>
  </view>
  
  <!-- 试用已结束 -->
  <view class="trial-card trial-expired" wx:elif="{{subscriptionInfo.trial_end_date && !subscriptionInfo.trial_available && !subscriptionInfo.is_subscribed}}">
    <view class="trial-content">
      <view class="trial-title">⏰ 试用已结束</view>
      <view class="trial-desc">
        您的7天免费试用期已结束，当前使用免费版功能
        <view class="trial-features expired">
          ❌ AI音乐生成受限
          ❌ 无法播放长序列音乐
          ❌ 无法下载高品质音频
        </view>
      </view>
      <view class="trial-upgrade-info">
        立即订阅，恢复所有高级功能
      </view>
    </view>
  </view>
  
  <!-- 需要登录状态 -->
  <view class="trial-card trial-login-required" wx:elif="{{subscriptionInfo.requires_login}}">
    <view class="trial-content">
      <view class="trial-title">🔐 请先登录</view>
      <view class="trial-desc">
        登录后可查看您的订阅状态并开始免费试用
      </view>
      <view class="trial-btn" bind:tap="onGoToLogin">
        立即登录
      </view>
    </view>
  </view>

  <!-- Tab导航 -->
  <view class="tab-nav" wx:if="{{!loading}}">
    <view 
      class="tab-item {{currentTab === 'subscription' ? 'active' : ''}}"
      data-tab="subscription"
      bind:tap="onSwitchTab"
    >
      📅 订阅套餐
    </view>
    <view 
      class="tab-item {{currentTab === 'package' ? 'active' : ''}}"
      data-tab="package"
      bind:tap="onSwitchTab"
    >
      🎁 次数套餐
    </view>
  </view>

  <!-- 用户次数显示 -->
  <view class="user-counts" wx:if="{{userCounts && currentTab === 'package'}}">
    <view class="counts-header">我的剩余次数</view>
    <view class="counts-list">
      <view class="count-item" wx:for="{{userCounts}}" wx:key="type">
        <view class="count-type">{{item.type_name || item.type}}</view>
        <view class="count-value">{{item.remaining_count}}次</view>
        <view class="count-expire" wx:if="{{item.expire_date}}">
          到期：{{item.expire_date}}
        </view>
      </view>
    </view>
  </view>

  <!-- 优惠券兑换按钮 -->
  <view class="coupon-section" wx:if="{{currentTab === 'package'}}">
    <view class="coupon-btn" bind:tap="onShowCouponModal">
      🎫 兑换优惠券
    </view>
  </view>

  <!-- 订阅套餐选择 -->
  <view class="plans-section" wx:if="{{!loading && currentTab === 'subscription'}}">
    <view class="section-title">选择订阅套餐</view>
    
    <view class="plans-list">
      <view 
        class="plan-card {{selectedPlan === item.id ? 'selected' : ''}}"
        wx:for="{{subscriptionPlans}}"
        wx:key="id"
        data-plan-id="{{item.id}}"
        bind:tap="onSelectPlan"
      >
        <!-- 套餐标签 -->
        <view class="plan-badge {{item.discount ? 'discount' : ''}}" wx:if="{{item.discount || item.type === 'vip'}}">
          {{item.discount || (item.type === 'vip' ? 'VIP' : '推荐')}}
        </view>
        
        <!-- 套餐头部 -->
        <view class="plan-header">
          <view class="plan-name">{{item.name}}</view>
          <view class="plan-price">
            <view class="price-amount">¥{{item.price}}</view>
            <view class="price-period">{{item.duration === 30 ? '/月' : item.duration === 365 ? '/年' : '/' + item.duration + '天'}}</view>
            <view class="price-discount" wx:if="{{item.discount}}">{{item.discount}}</view>
          </view>
        </view>
        
        <!-- 套餐特性 -->
        <view class="plan-features">
          <view class="feature-item" wx:for="{{item.features}}" wx:for-item="feature" wx:key="*this">
            <view class="feature-icon"></view>
            <text>{{feature}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 次数套餐选择 -->
  <view class="plans-section" wx:if="{{!loading && currentTab === 'package'}}">
    <view class="section-title">选择次数套餐</view>
    
    <view class="plans-list">
      <view 
        class="package-card {{selectedPackage === item.id ? 'selected' : ''}}"
        wx:for="{{countPackages}}"
        wx:key="id"
        data-package-id="{{item.id}}"
        bind:tap="onSelectPackage"
      >
        <!-- 套餐标签 -->
        <view class="package-badge {{item.bonus_count > 0 ? 'bonus' : ''}}" wx:if="{{item.bonus_count > 0}}">
          送{{item.bonus_count}}次
        </view>
        
        <!-- 套餐头部 -->
        <view class="package-header">
          <view class="package-name">{{item.name}}</view>
          <view class="package-price">
            <view class="price-amount">¥{{item.price}}</view>
            <view class="price-unit">/{{item.total_count}}次</view>
          </view>
        </view>
        
        <!-- 套餐内容 -->
        <view class="package-content">
          <view class="package-info">
            <view class="info-item">
              <text class="info-label">购买次数：</text>
              <text class="info-value">{{item.count}}次</text>
            </view>
            <view class="info-item" wx:if="{{item.bonus_count > 0}}">
              <text class="info-label">赠送次数：</text>
              <text class="info-value bonus">{{item.bonus_count}}次</text>
            </view>
            <view class="info-item">
              <text class="info-label">总共获得：</text>
              <text class="info-value total">{{item.total_count}}次</text>
            </view>
            <view class="info-item" wx:if="{{item.valid_days}}">
              <text class="info-label">有效期：</text>
              <text class="info-value">{{item.valid_days}}天</text>
            </view>
          </view>
          
          <!-- 适用功能 -->
          <view class="package-features" wx:if="{{item.features && item.features.length > 0}}">
            <view class="features-title">套餐特性</view>
            <view class="feature-item" wx:for="{{item.features}}" wx:for-item="feature" wx:key="*this">
              <view class="feature-icon"></view>
              <text>{{feature}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 加载状态 -->
  <view class="loading" wx:if="{{loading}}">
    <view class="loading-icon"></view>
    <view>正在加载套餐信息...</view>
  </view>

  <!-- 空状态 -->
  <view class="empty-state" wx:if="{{!loading && currentTab === 'subscription' && subscriptionPlans.length === 0}}">
    <view class="empty-icon">📦</view>
    <view class="empty-text">暂无可用套餐</view>
  </view>
  
  <view class="empty-state" wx:if="{{!loading && currentTab === 'package' && countPackages.length === 0}}">
    <view class="empty-icon">🎁</view>
    <view class="empty-text">暂无可用次数套餐</view>
  </view>
</view>

<!-- 购买按钮 -->
<view class="purchase-section" wx:if="{{!loading && ((currentTab === 'subscription' && subscriptionPlans.length > 0) || (currentTab === 'package' && countPackages.length > 0))}}">
  <view 
    class="purchase-btn {{purchasing || (!selectedPlan && !selectedPackage) ? 'disabled' : ''}}"
    bind:tap="onPurchaseSubscription"
  >
    <text wx:if="{{purchasing}}">处理中...</text>
    <text wx:elif="{{currentTab === 'subscription'}}">立即订阅</text>
    <text wx:else>立即购买</text>
  </view>
  
  <!-- 底部链接 -->
  <view class="footer-links">
    <text class="footer-link" bind:tap="onViewAgreement">用户协议</text>
    <text class="footer-link" bind:tap="onContactService">联系客服</text>
  </view>
</view>

<!-- 优惠券兑换模态框 -->
<view class="coupon-modal" wx:if="{{showCouponModal}}">
  <view class="modal-mask" bind:tap="onHideCouponModal"></view>
  <view class="modal-content">
    <view class="modal-header">
      <view class="modal-title">🎫 兑换优惠券</view>
      <view class="modal-close" bind:tap="onHideCouponModal">✕</view>
    </view>
    
    <view class="modal-body">
      <view class="input-section">
        <view class="input-label">请输入优惠券码</view>
        <input 
          class="coupon-input"
          type="text"
          placeholder="请输入优惠券码"
          value="{{couponCode}}"
          bindinput="onCouponInput"
          maxlength="20"
        />
      </view>
      
      <view class="coupon-tips">
        <view class="tip-item">• 优惠券码不区分大小写</view>
        <view class="tip-item">• 每个优惠券只能使用一次</view>
        <view class="tip-item">• 兑换成功后次数将立即到账</view>
      </view>
    </view>
    
    <view class="modal-footer">
      <view class="modal-btn cancel" bind:tap="onHideCouponModal">取消</view>
      <view class="modal-btn confirm" bind:tap="onRedeemCoupon">兑换</view>
    </view>
  </view>
</view>
