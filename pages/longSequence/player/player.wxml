<!--pages/longSequence/player/player.wxml-->
<!-- 长序列音乐播放器页面 -->
<theme-switcher 
  show-theme-switcher="{{true}}" 
  page-type="default"
  bind:themechange="onThemeChange"
/>
<view class="page-container {{themeClass}}">
  <!-- 页面内容 -->
  <view class="page-content">
    <!-- 加载状态 -->
    <view wx:if="{{loading}}" class="loading-container">
      <view class="loading-spinner"></view>
      <view class="loading-text">正在加载长序列音乐...</view>
    </view>

    <!-- 播放器主界面 -->
    <view wx:else class="player-container">
      <!-- 有会话信息时显示播放器内容 -->
      <view wx:if="{{sessionInfo}}">
        <!-- 音乐封面区域 -->
        <view class="music-cover-section">
          <view class="cover-container">
            <image
              class="cover-image {{isPlaying ? 'rotating' : ''}}"
              src="{{sessionInfo.cover_url || '/images/default-sequence-cover.svg'}}"
              mode="aspectFill"
            ></image>
            <view class="cover-overlay">
              <view class="play-indicator {{isPlaying ? 'playing' : ''}}">
                <view class="pulse-ring"></view>
                <view class="pulse-ring-delay"></view>
              </view>
            </view>
          </view>
        </view>

        <!-- 音乐信息区域 -->
        <view class="music-info-section">
          <view class="music-title">{{sessionInfo.total_duration_minutes}}分钟疗愈音乐</view>
          <view class="music-subtitle">
            长序列版本 · {{sessionInfo.segment_count}}段序列
          </view>
          <view class="music-description">
            基于心理评测生成的完整疗愈音乐体验
          </view>
          
          <!-- 音乐标签 -->
          <view class="music-tags">
            <view class="tag">长序列音乐</view>
            <view class="tag">{{sessionInfo.total_duration_minutes}}分钟</view>
            <view class="tag">{{sessionInfo.segment_count}}段</view>
          </view>
        </view>

        <!-- ISO疗愈阶段进度（长序列特色功能） -->
        <view wx:if="{{isoPhases}}" class="iso-phases-section">
          <view class="phases-header">
            <view class="phases-title">
              <text class="title-icon">🧘‍♀️</text>
              <text class="title-text">疗愈阶段</text>
            </view>
            <button class="phase-info-btn" bindtap="onTogglePhaseInfo">
              <image class="phase-icon" src="/images/info.svg" mode="aspectFit"></image>
            </button>
          </view>
          
          <!-- 美化的阶段进度条 -->
          <view class="phases-progress-container">
            <view class="phases-progress">
              <view class="phase-item {{currentPhase === 'iso' ? 'active' : 'completed'}}">
                <view class="phase-dot">
                  <text class="phase-emoji">🌱</text>
                </view>
                <view class="phase-label">同质期</view>
                <view class="phase-description">匹配当前状态</view>
              </view>
              <view class="phase-line {{currentPhase !== 'iso' ? 'completed' : ''}}">
                <view class="phase-line-fill"></view>
              </view>
              
              <view class="phase-item {{currentPhase === 'transition' ? 'active' : (currentPhase === 'target' ? 'completed' : '')}}">
                <view class="phase-dot">
                  <text class="phase-emoji">🌊</text>
                </view>
                <view class="phase-label">过渡期</view>
                <view class="phase-description">渐进式引导</view>
              </view>
              <view class="phase-line {{currentPhase === 'target' ? 'completed' : ''}}">
                <view class="phase-line-fill"></view>
              </view>
              
              <view class="phase-item {{currentPhase === 'target' ? 'active' : ''}}">
                <view class="phase-dot">
                  <text class="phase-emoji">✨</text>
                </view>
                <view class="phase-label">目标期</view>
                <view class="phase-description">达到目标状态</view>
              </view>
            </view>
          </view>

          <!-- 美化的当前阶段信息 -->
          <view class="current-phase-card">
            <view class="phase-status">
              <view class="status-icon">{{currentPhase === 'iso' ? '🌱' : currentPhase === 'transition' ? '🌊' : '✨'}}</view>
              <view class="status-content">
                <view class="status-title">{{getPhaseDescription(currentPhase)}}</view>
                <view class="status-subtitle">正在为您定制疗愈体验</view>
              </view>
            </view>
            
            <view class="progress-container">
              <view class="progress-bar">
                <view class="progress-fill" style="width: {{phaseProgress}}%"></view>
                <view class="progress-glow" style="left: {{phaseProgress}}%"></view>
              </view>
              <view class="progress-text">{{Math.round(phaseProgress)}}%</view>
            </view>
          </view>

          <!-- 阶段详情弹窗 -->
          <view wx:if="{{showPhaseInfo}}" class="phase-detail-modal" bindtap="onTogglePhaseInfo">
            <view class="modal-content" catch:tap="">
              <view class="modal-header">
                <text class="modal-title">ISO疗愈原理</text>
                <button class="modal-close" bindtap="onTogglePhaseInfo">×</button>
              </view>
              <view class="phase-details">
                <view class="phase-detail-item">
                  <view class="phase-detail-title">同质期 (ISO)</view>
                  <view class="phase-detail-desc">匹配当前情绪状态，建立共鸣</view>
                </view>
                <view class="phase-detail-item">
                  <view class="phase-detail-title">过渡期 (Transition)</view>
                  <view class="phase-detail-desc">渐进式引导，缓慢改变情绪</view>
                </view>
                <view class="phase-detail-item">
                  <view class="phase-detail-title">目标期 (Target)</view>
                  <view class="phase-detail-desc">达到理想的放松疗愈状态</view>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- 长序列分析信息 -->
        <view wx:if="{{sessionInfo && sessionInfo.analysis}}" class="analysis-section">
          <view class="analysis-title">长序列分析</view>
          <view class="analysis-content">
            <view class="analysis-item">
              <text class="analysis-label">疗愈类型</text>
              <text class="analysis-value">{{sessionInfo.analysis.therapy_type || '情绪调节'}}</text>
            </view>
            <view class="analysis-item">
              <text class="analysis-label">序列长度</text>
              <text class="analysis-value">{{sessionInfo.total_duration_minutes}}分钟</text>
            </view>
            <view class="analysis-item">
              <text class="analysis-label">段落数量</text>
              <text class="analysis-value">{{sessionInfo.segment_count}}段</text>
            </view>
          </view>
        </view>

        <!-- 操作区域 -->
        <view class="action-section">
          <view class="action-buttons">
            <button class="action-btn" bindtap="onJumpToPhase" data-phase="iso">
              <image class="action-icon" src="/images/iso-phase.svg" mode="aspectFit"></image>
              <text class="action-text">同质期</text>
            </button>

            <button class="action-btn" bindtap="onToggleFavorite">
              <image 
                class="action-icon {{isFavorite ? 'active' : ''}}" 
                src="{{isFavorite ? '/images/heart-filled.svg' : '/images/heart.svg'}}" 
                mode="aspectFit"
              ></image>
              <text class="action-text">{{isFavorite ? '已收藏' : '收藏'}}</text>
            </button>

            <button class="action-btn" bindtap="onDownloadMusic">
              <image class="action-icon" src="/images/download.svg" mode="aspectFit"></image>
              <text class="action-text">下载</text>
            </button>
          </view>
        </view>
      </view>

      <!-- 无会话信息时的空状态 -->
      <view wx:else class="empty-state">
        <image class="empty-icon" src="/images/empty-music.svg" mode="aspectFit"></image>
        <view class="empty-title">未找到长序列</view>
        <view class="empty-subtitle">请检查会话是否存在</view>
        <button class="btn primary" bindtap="onNavigateBack">返回</button>
      </view>
    </view>
  </view>
</view>

<!-- 统一底部播放器 -->
<global-player 
  id="globalPlayer"
  visible="{{showGlobalPlayer}}"
  bind:playStateChange="onGlobalPlayerStateChange"
  bind:nextTrack="onNextTrack"
  bind:previousTrack="onPreviousTrack"
  bind:closePlayer="onCloseGlobalPlayer"
  bind:expandPlayer="onExpandGlobalPlayer"
/>

<!-- 底部菜单栏 -->
<global-tabbar 
  currentPage="longSequence/player"
  themeClass="{{themeClass}}"
/>
