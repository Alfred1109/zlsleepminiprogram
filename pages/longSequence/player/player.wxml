<!--pages/longSequence/player/player.wxml-->
<!-- é•¿åºåˆ—éŸ³ä¹æ’­æ”¾å™¨é¡µé¢ -->
<theme-switcher 
  show-theme-switcher="{{true}}" 
  page-type="default"
  bind:themechange="onThemeChange"
/>
<view class="page-container {{themeClass}}">
  <!-- é¡µé¢å†…å®¹ -->
  <view class="page-content">
    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{loading}}" class="loading-container">
      <view class="loading-spinner"></view>
      <view class="loading-text">æ­£åœ¨åŠ è½½é•¿åºåˆ—éŸ³ä¹...</view>
    </view>

    <!-- æ’­æ”¾å™¨ä¸»ç•Œé¢ -->
    <view wx:else class="player-container">
      <!-- æœ‰ä¼šè¯ä¿¡æ¯æ—¶æ˜¾ç¤ºæ’­æ”¾å™¨å†…å®¹ -->
      <view wx:if="{{sessionInfo}}">
        <!-- éŸ³ä¹å°é¢åŒºåŸŸ -->
        <view class="music-cover-section">
          <view class="cover-container">
            <image
              class="cover-image {{isPlaying ? 'rotating' : ''}}"
              src="{{sessionInfo.cover_url || '/images/default-sequence-cover.svg'}}"
              mode="aspectFill"
            ></image>
            <view class="cover-overlay">
              <view class="play-indicator {{isPlaying ? 'playing' : ''}}">
                <view class="pulse-ring"></view>
                <view class="pulse-ring-delay"></view>
              </view>
            </view>
          </view>
        </view>

        <!-- éŸ³ä¹ä¿¡æ¯åŒºåŸŸ -->
        <view class="music-info-section">
          <view class="music-title">{{sessionInfo.total_duration_minutes}}åˆ†é’Ÿç–—æ„ˆéŸ³ä¹</view>
          <view class="music-subtitle">
            é•¿åºåˆ—ç‰ˆæœ¬ Â· {{sessionInfo.segment_count}}æ®µåºåˆ—
          </view>
          <view class="music-description">
            åŸºäºå¿ƒç†è¯„æµ‹ç”Ÿæˆçš„å®Œæ•´ç–—æ„ˆéŸ³ä¹ä½“éªŒ
          </view>
          
          <!-- éŸ³ä¹æ ‡ç­¾ -->
          <view class="music-tags">
            <view class="tag">é•¿åºåˆ—éŸ³ä¹</view>
            <view class="tag">{{sessionInfo.total_duration_minutes}}åˆ†é’Ÿ</view>
            <view class="tag">{{sessionInfo.segment_count}}æ®µ</view>
          </view>
        </view>

        <!-- ISOç–—æ„ˆé˜¶æ®µè¿›åº¦ï¼ˆé•¿åºåˆ—ç‰¹è‰²åŠŸèƒ½ï¼‰ -->
        <view wx:if="{{isoPhases}}" class="iso-phases-section">
          <view class="phases-header">
            <view class="phases-title">
              <text class="title-icon">ğŸ§˜â€â™€ï¸</text>
              <text class="title-text">ç–—æ„ˆé˜¶æ®µ</text>
            </view>
            <button class="phase-info-btn" bindtap="onTogglePhaseInfo">
              <image class="phase-icon" src="/images/info.svg" mode="aspectFit"></image>
            </button>
          </view>
          
          <!-- ç¾åŒ–çš„é˜¶æ®µè¿›åº¦æ¡ -->
          <view class="phases-progress-container">
            <view class="phases-progress">
              <view class="phase-item {{currentPhase === 'iso' ? 'active' : 'completed'}}">
                <view class="phase-dot">
                  <text class="phase-emoji">ğŸŒ±</text>
                </view>
                <view class="phase-label">åŒè´¨æœŸ</view>
                <view class="phase-description">åŒ¹é…å½“å‰çŠ¶æ€</view>
              </view>
              <view class="phase-line {{currentPhase !== 'iso' ? 'completed' : ''}}">
                <view class="phase-line-fill"></view>
              </view>
              
              <view class="phase-item {{currentPhase === 'transition' ? 'active' : (currentPhase === 'target' ? 'completed' : '')}}">
                <view class="phase-dot">
                  <text class="phase-emoji">ğŸŒŠ</text>
                </view>
                <view class="phase-label">è¿‡æ¸¡æœŸ</view>
                <view class="phase-description">æ¸è¿›å¼å¼•å¯¼</view>
              </view>
              <view class="phase-line {{currentPhase === 'target' ? 'completed' : ''}}">
                <view class="phase-line-fill"></view>
              </view>
              
              <view class="phase-item {{currentPhase === 'target' ? 'active' : ''}}">
                <view class="phase-dot">
                  <text class="phase-emoji">âœ¨</text>
                </view>
                <view class="phase-label">ç›®æ ‡æœŸ</view>
                <view class="phase-description">è¾¾åˆ°ç›®æ ‡çŠ¶æ€</view>
              </view>
            </view>
          </view>

          <!-- ç¾åŒ–çš„å½“å‰é˜¶æ®µä¿¡æ¯ -->
          <view class="current-phase-card">
            <view class="phase-status">
              <view class="status-icon">{{currentPhase === 'iso' ? 'ğŸŒ±' : currentPhase === 'transition' ? 'ğŸŒŠ' : 'âœ¨'}}</view>
              <view class="status-content">
                <view class="status-title">{{getPhaseDescription(currentPhase)}}</view>
                <view class="status-subtitle">æ­£åœ¨ä¸ºæ‚¨å®šåˆ¶ç–—æ„ˆä½“éªŒ</view>
              </view>
            </view>
            
            <view class="progress-container">
              <view class="progress-bar">
                <view class="progress-fill" style="width: {{phaseProgress}}%"></view>
                <view class="progress-glow" style="left: {{phaseProgress}}%"></view>
              </view>
              <view class="progress-text">{{Math.round(phaseProgress)}}%</view>
            </view>
          </view>

          <!-- é˜¶æ®µè¯¦æƒ…å¼¹çª— -->
          <view wx:if="{{showPhaseInfo}}" class="phase-detail-modal" bindtap="onTogglePhaseInfo">
            <view class="modal-content" catch:tap="">
              <view class="modal-header">
                <text class="modal-title">ISOç–—æ„ˆåŸç†</text>
                <button class="modal-close" bindtap="onTogglePhaseInfo">Ã—</button>
              </view>
              <view class="phase-details">
                <view class="phase-detail-item">
                  <view class="phase-detail-title">åŒè´¨æœŸ (ISO)</view>
                  <view class="phase-detail-desc">åŒ¹é…å½“å‰æƒ…ç»ªçŠ¶æ€ï¼Œå»ºç«‹å…±é¸£</view>
                </view>
                <view class="phase-detail-item">
                  <view class="phase-detail-title">è¿‡æ¸¡æœŸ (Transition)</view>
                  <view class="phase-detail-desc">æ¸è¿›å¼å¼•å¯¼ï¼Œç¼“æ…¢æ”¹å˜æƒ…ç»ª</view>
                </view>
                <view class="phase-detail-item">
                  <view class="phase-detail-title">ç›®æ ‡æœŸ (Target)</view>
                  <view class="phase-detail-desc">è¾¾åˆ°ç†æƒ³çš„æ”¾æ¾ç–—æ„ˆçŠ¶æ€</view>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- é•¿åºåˆ—åˆ†æä¿¡æ¯ -->
        <view wx:if="{{sessionInfo && sessionInfo.analysis}}" class="analysis-section">
          <view class="analysis-title">é•¿åºåˆ—åˆ†æ</view>
          <view class="analysis-content">
            <view class="analysis-item">
              <text class="analysis-label">ç–—æ„ˆç±»å‹</text>
              <text class="analysis-value">{{sessionInfo.analysis.therapy_type || 'æƒ…ç»ªè°ƒèŠ‚'}}</text>
            </view>
            <view class="analysis-item">
              <text class="analysis-label">åºåˆ—é•¿åº¦</text>
              <text class="analysis-value">{{sessionInfo.total_duration_minutes}}åˆ†é’Ÿ</text>
            </view>
            <view class="analysis-item">
              <text class="analysis-label">æ®µè½æ•°é‡</text>
              <text class="analysis-value">{{sessionInfo.segment_count}}æ®µ</text>
            </view>
          </view>
        </view>

        <!-- æ“ä½œåŒºåŸŸ -->
        <view class="action-section">
          <view class="action-buttons">
            <button class="action-btn" bindtap="onJumpToPhase" data-phase="iso">
              <image class="action-icon" src="/images/iso-phase.svg" mode="aspectFit"></image>
              <text class="action-text">åŒè´¨æœŸ</text>
            </button>

            <button class="action-btn" bindtap="onToggleFavorite">
              <image 
                class="action-icon {{isFavorite ? 'active' : ''}}" 
                src="{{isFavorite ? '/images/heart-filled.svg' : '/images/heart.svg'}}" 
                mode="aspectFit"
              ></image>
              <text class="action-text">{{isFavorite ? 'å·²æ”¶è—' : 'æ”¶è—'}}</text>
            </button>

            <button class="action-btn" bindtap="onDownloadMusic">
              <image class="action-icon" src="/images/download.svg" mode="aspectFit"></image>
              <text class="action-text">ä¸‹è½½</text>
            </button>
          </view>
        </view>
      </view>

      <!-- æ— ä¼šè¯ä¿¡æ¯æ—¶çš„ç©ºçŠ¶æ€ -->
      <view wx:else class="empty-state">
        <image class="empty-icon" src="/images/empty-music.svg" mode="aspectFit"></image>
        <view class="empty-title">æœªæ‰¾åˆ°é•¿åºåˆ—</view>
        <view class="empty-subtitle">è¯·æ£€æŸ¥ä¼šè¯æ˜¯å¦å­˜åœ¨</view>
        <button class="btn primary" bindtap="onNavigateBack">è¿”å›</button>
      </view>
    </view>
  </view>
</view>

<!-- ç»Ÿä¸€åº•éƒ¨æ’­æ”¾å™¨ -->
<global-player 
  id="globalPlayer"
  visible="{{showGlobalPlayer}}"
  bind:playStateChange="onGlobalPlayerStateChange"
  bind:nextTrack="onNextTrack"
  bind:previousTrack="onPreviousTrack"
  bind:closePlayer="onCloseGlobalPlayer"
  bind:expandPlayer="onExpandGlobalPlayer"
/>

<!-- åº•éƒ¨èœå•æ  -->
<global-tabbar 
  currentPage="longSequence/player"
  themeClass="{{themeClass}}"
/>
