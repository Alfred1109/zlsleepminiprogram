<!--pages/music/generate/generate.wxml-->
<!-- 音乐生成页面 -->
<!-- 主题切换器 -->
<theme-switcher 
  show-theme-switcher="{{true}}" 
  page-type="default"
  bind:themechange="onThemeChange"
/>
<view class="page-container {{themeClass}}">
  <!-- 页面标题 -->
  <view class="page-header">
    <view class="header-icon">🎵</view>
    <view class="page-title">AI音乐生成</view>
    <view class="page-subtitle">基于您的心理评测结果，生成个性化疗愈音乐</view>
  </view>

  <!-- 页面内容 -->
  <view class="page-content">
    <!-- 加载状态 -->
    <view wx:if="{{loading}}" class="loading-container">
      <view class="loading-spinner"></view>
      <view class="loading-text">正在加载评测记录...</view>
    </view>

    <!-- 主要内容 -->
    <view wx:else>
      <!-- 场景模式提示 -->
      <view wx:if="{{isInSceneMode}}" class="scene-mode-tip">
        <view class="tip-icon">🎯</view>
        <view class="tip-content">
          <view class="tip-title">场景化综合疗愈</view>
          <view class="tip-text">{{sceneHint}}</view>
        </view>
      </view>

      <!-- 评测记录选择 -->
      <view class="content-section">
        <view class="section-header">
          <view>
            <view class="section-title">
              {{selectionMode === 'single' ? '选择评测记录' : '选择评测记录 (多选)'}}
            </view>
            <view class="section-subtitle">
              {{selectionMode === 'single' ? '基于单个评测结果生成音乐' : '基于多个评测结果综合生成音乐'}}
            </view>
          </view>
        </view>

        <!-- 无评测记录 -->
        <view wx:if="{{recentAssessments.length === 0}}" class="empty-container">
          <image class="empty-icon" src="/images/empty-assessment.svg" mode="aspectFit"></image>
          <view class="empty-title">暂无评测记录</view>
          <view class="empty-subtitle">请先完成心理健康评测</view>
          <button class="btn btn-primary" bindtap="onGoToAssessment">去做评测</button>
        </view>

        <!-- 评测记录列表 -->
        <view wx:else class="assessment-list">
        <view 
          wx:for="{{recentAssessments}}" 
          wx:key="scale_id"
          class="assessment-item {{item.isSelected ? (selectionMode === 'single' ? 'selected' : 'selected-multiple') : ''}}"
          data-assessment="{{item}}"
          bindtap="onSelectAssessment"
        >
          <!-- 单选/多选指示器 -->
          <view class="selection-indicator">
            <!-- 单选模式：圆形radio -->
            <view wx:if="{{selectionMode === 'single'}}" class="radio-indicator {{item.isSelected ? 'radio-checked' : ''}}">
              <view wx:if="{{item.isSelected}}" class="radio-dot"></view>
            </view>
            
            <!-- 多选模式：方形checkbox -->
            <view wx:else class="checkbox-indicator {{item.isSelected ? 'checkbox-checked' : ''}}">
              <image wx:if="{{item.isSelected}}" class="checkbox-icon" src="/images/check.svg" mode="aspectFit"></image>
            </view>
          </view>
          
          <!-- 评测信息 -->
          <view class="assessment-content">
            <view class="assessment-header">
              <view class="assessment-name">{{item.scale_name}}</view>
              <view class="assessment-time">{{formatTime(item.completed_at)}}</view>
            </view>
            
            <view class="assessment-result">
              <view class="result-score">
                <text class="score-label">总分：</text>
                <text class="score-value">{{item.total_score}}</text>
              </view>
              <view 
                class="result-level"
                style="color: {{getSeverityColor(item.severity_level)}}"
              >
                {{item.severity_level === 'normal' ? '正常' : 
                  item.severity_level === 'mild' ? '轻度' :
                  item.severity_level === 'moderate' ? '中度' : '重度'}}
              </view>
            </view>
          </view>
        </view>
        </view>
      </view>

      <!-- 生成按钮区域 -->
      <view wx:if="{{recentAssessments.length > 0}}" class="content-section">
        <view class="section-header">
          <view class="section-title">音乐生成</view>
        </view>

        <view class="card">
          <view class="generate-info">
            <view class="info-title">生成说明</view>
            <view class="info-content">
              <view wx:if="{{selectionMode === 'single'}}" class="single-mode-info">
                <view class="info-item">• 基于您的评测结果分析情绪状态</view>
                <view class="info-item">• 智能匹配适合的音乐元素</view>
                <view class="info-item">• 生成个性化的60秒疗愈音乐</view>
              </view>
              
              <view wx:else class="multiple-mode-info">
                <view class="info-item">• 综合分析多个评测的心理状态</view>
                <view class="info-item">• 场景化智能匹配最佳音乐元素</view>
                <view class="info-item">• 生成综合疗愈的60秒个性化音乐</view>
                <view class="info-item selected-count">• 已选择 {{selectedCount}} 个评测进行综合生成</view>
              </view>
            </view>
          </view>

          <button
            class="btn btn-primary btn-block {{generating ? 'generating' : ''}}"
            disabled="{{!canGenerate}}"
            bindtap="onGenerateMusic"
          >
            <view wx:if="{{generating}}" class="btn-loading">
              <view class="loading-spinner small"></view>
              <text>{{generatingText}}</text>
            </view>
            <text wx:else>{{generateButtonText}}</text>
          </button>
        </view>
      </view>

      <!-- 快捷操作 -->
      <view class="content-section">
        <view class="section-header">
          <view class="section-title">快捷操作</view>
        </view>

        <view class="quick-actions">
          <view class="action-item" bindtap="onViewMusicLibrary">
            <image class="action-icon" src="/images/music-library.svg" mode="aspectFit"></image>
            <view class="action-text">音乐库</view>
          </view>
          <view class="action-item" bindtap="onGoToAssessment">
            <image class="action-icon" src="/images/assessment.svg" mode="aspectFit"></image>
            <view class="action-text">新评测</view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- 统一底部播放器 -->
<global-player 
  id="globalPlayer"
  visible="{{showGlobalPlayer}}"
  bind:playStateChange="onGlobalPlayerStateChange"
  bind:nextTrack="onNextTrack"
  bind:previousTrack="onPreviousTrack"
  bind:closePlayer="onCloseGlobalPlayer"
  bind:expandPlayer="onExpandGlobalPlayer"
/>
