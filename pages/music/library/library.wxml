<!--pages/music/library/library.wxml-->
<!-- è„‘æ³¢åº“é¡µé¢ -->
<view class="page-container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <view class="page-header-title">è„‘æ³¢åº“</view>
    <view class="page-header-subtitle">æ‚¨çš„ä¸“å±AIç–—æ„ˆè„‘æ³¢</view>
  </view>

  <!-- åœºæ™¯çŠ¶æ€æŒ‡ç¤ºå™¨ -->
  <view wx:if="{{isInSceneMode}}" class="scene-indicator">
    <view class="scene-indicator-content">
      <view class="scene-indicator-icon">ğŸ¯</view>
      <view class="scene-indicator-text">
        <text class="scene-indicator-title">{{sceneHint}}</text>
        <text class="scene-indicator-subtitle">åªæ˜¾ç¤ºç›¸å…³è„‘æ³¢</text>
      </view>
      <view class="scene-indicator-action" bindtap="exitSceneMode">
        <text class="exit-text">é€€å‡º</text>
      </view>
    </view>
  </view>

  <!-- é¡µé¢å†…å®¹ -->
  <view class="page-content">

    <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
    <view class="tab-container">
      <view
        class="tab-item {{currentTab === 'music' ? 'active' : ''}}"
        data-tab="music"
        bindtap="onTabChange"
      >
        <view class="tab-icon">ğŸµ</view>
        <text class="tab-text">60ç§’è„‘æ³¢</text>
        <view wx:if="{{filteredMusicList.length > 0}}" class="tab-badge">{{filteredMusicList.length}}</view>
        <view wx:if="{{isInSceneMode && filteredMusicList.length !== musicList.length}}" class="tab-filter-hint">
          /{{musicList.length}}
        </view>
      </view>
      <view
        class="tab-item {{currentTab === 'longSequence' ? 'active' : ''}}"
        data-tab="longSequence"
        bindtap="onTabChange"
      >
        <view class="tab-icon">ğŸ¼</view>
        <text class="tab-text">é•¿åºåˆ—è„‘æ³¢</text>
        <view wx:if="{{filteredLongSequenceList.length > 0}}" class="tab-badge">{{filteredLongSequenceList.length}}</view>
        <view wx:if="{{isInSceneMode && filteredLongSequenceList.length !== longSequenceList.length}}" class="tab-filter-hint">
          /{{longSequenceList.length}}
        </view>
      </view>
    </view>

    <!-- è®¢é˜…çŠ¶æ€å¡ç‰‡ -->
    <view class="subscription-status-card">
      <view class="status-header">
        <view class="status-icon-container">
          <text class="status-icon">{{subscriptionStatus.statusIcon}}</text>
        </view>
        <view class="status-info">
          <view class="status-title" style="color: {{subscriptionStatus.statusColor}}">
            {{subscriptionStatus.displayName}}
          </view>
          <view wx:if="{{subscriptionStatus.daysLeft > 0}}" class="status-expiry">
            å‰©ä½™ {{subscriptionStatus.daysLeft}} å¤©
          </view>
          <view wx:elif="{{subscriptionStatus.expiresAt}}" class="status-expiry expired">
            å·²è¿‡æœŸ
          </view>
        </view>
        <view wx:if="{{subscriptionStatus.showUpgrade}}" class="upgrade-btn">
          <button class="btn-upgrade" bindtap="onUpgradeSubscription">å‡çº§</button>
        </view>
      </view>
      
      <view class="status-features">
        <view class="features-title">å¯ç”¨åŠŸèƒ½</view>
        <view class="features-list">
          <text wx:for="{{subscriptionStatus.features}}" wx:key="*this" class="feature-item">
            â€¢ {{item}}
          </text>
        </view>
      </view>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{loading}}" class="loading-container">
      <view class="loading-spinner"></view>
      <view class="loading-text">åŠ è½½è„‘æ³¢åº“ä¸­...</view>
    </view>

  <!-- 60ç§’è„‘æ³¢åˆ—è¡¨ -->
  <view wx:elif="{{currentTab === 'music'}}" class="content-container">
    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{filteredMusicList.length === 0}}" class="empty-state">
      <image class="empty-icon" src="/images/empty-music.svg" mode="aspectFit" />
      
      <!-- è®¿å®¢æ¨¡å¼ -->
      <block wx:if="{{isGuestMode}}">
        <view class="empty-text">è¯·å…ˆç™»å½•æŸ¥çœ‹æ‚¨çš„è„‘æ³¢</view>
        <view class="empty-desc">ç™»å½•åå¯æŸ¥çœ‹æ‚¨ç”Ÿæˆçš„ä¸“å±AIç–—æ„ˆè„‘æ³¢</view>
        <button class="btn-primary" bindtap="promptLogin">å»ç™»å½•</button>
      </block>
      
      <!-- åœºæ™¯æ¨¡å¼ä¸‹æ— åŒ¹é…è„‘æ³¢ -->
      <block wx:elif="{{isInSceneMode && musicList.length > 0}}">
        <view class="empty-text">å½“å‰åœºæ™¯æš‚æ— ç›¸å…³è„‘æ³¢</view>
        <view class="empty-desc">æ‚¨å¯ä»¥ç”Ÿæˆæ›´å¤šè„‘æ³¢æˆ–é€€å‡ºåœºæ™¯æ¨¡å¼æŸ¥çœ‹å…¨éƒ¨</view>
        <view class="empty-actions">
          <button class="btn-secondary" bindtap="exitSceneMode">æŸ¥çœ‹å…¨éƒ¨è„‘æ³¢</button>
          <button class="btn-primary" bindtap="onGoToGenerate">ç”Ÿæˆè„‘æ³¢</button>
        </view>
      </block>
      
      <!-- æ™®é€šç©ºçŠ¶æ€ -->
      <block wx:else>
        <view class="empty-text">æš‚æ— è„‘æ³¢</view>
        <view class="empty-desc">å¿«å»ç”Ÿæˆæ‚¨çš„ä¸“å±AIç–—æ„ˆè„‘æ³¢å§</view>
        <button class="btn-primary" bindtap="onGoToGenerate">ç”Ÿæˆè„‘æ³¢</button>
      </block>
      
      <!-- è°ƒè¯•ä¿¡æ¯ -->
      <view wx:if="{{userInfo}}" class="debug-info" style="margin-top: 20rpx; font-size: 24rpx; color: #999;">
        ç”¨æˆ·ID: {{userInfo.id || userInfo.user_id || userInfo.userId || 'æœªçŸ¥'}}
      </view>
    </view>

    <!-- è„‘æ³¢åˆ—è¡¨ -->
    <view wx:else class="music-list">
      <view 
        wx:for="{{filteredMusicList}}" 
        wx:key="id"
        class="music-item"
        data-music="{{item}}"
        bindtap="onPlayMusic"
      >
        <view class="music-cover">
          <image
            class="cover-image"
            src="{{item.cover_url || '/images/default-music-cover.svg'}}"
            mode="aspectFill"
          />
          
          <!-- æ’­æ”¾çŠ¶æ€æŒ‡ç¤ºå™¨ -->
          <view wx:if="{{currentPlayingId === item.id && currentPlayingType === 'music'}}" class="playing-indicator">
            <view class="wave wave1"></view>
            <view class="wave wave2"></view>
            <view class="wave wave3"></view>
          </view>
          <view wx:else class="play-overlay">
            <image class="play-icon" src="/images/play-white.svg" mode="aspectFit" />
          </view>
        </view>

        <view class="music-info">
          <view class="music-title">
            {{generateMusicTitle(item)}}
          </view>
          <view class="music-subtitle">
            åŸºäº {{item.assessment_scale_name || 'å¿ƒç†è¯„æµ‹'}} Â· {{formatAssessmentDate(item.assessment_date)}}
          </view>
          <view class="music-meta">
            <view class="meta-item">
              <text class="meta-icon">â±ï¸</text>
              <text class="meta-text">{{formatTime(item.duration)}}</text>
            </view>
            <view class="meta-item">
              <text class="meta-icon">ğŸ­</text>
              <text class="meta-text">{{item.mood || 'æ”¾æ¾ç–—æ„ˆ'}}</text>
            </view>
            <view class="meta-item">
              <text class="meta-icon">ğŸ“Š</text>
              <text class="meta-text">{{item.assessment_score || '--'}}åˆ†</text>
            </view>
          </view>
          <view class="music-tags">
            <text class="music-tag">{{item.music_style || 'ç–—æ„ˆ'}}</text>
            <text class="music-tag">{{item.tempo || 'ä¸­é€Ÿ'}}</text>
            <text wx:if="{{item.is_favorite}}" class="music-tag favorite">æ”¶è—</text>
          </view>
        </view>

        <view class="music-actions">
          <button 
            class="action-btn-with-text"
            data-music="{{item}}"
            catchtap="onToggleFavorite"
          >
            <view class="btn-icon">
              <image
                class="action-icon {{item.is_favorite ? 'active' : ''}}"
                src="{{item.is_favorite ? '/images/heart-filled.svg' : '/images/heart.svg'}}"
                mode="aspectFit"
              />
            </view>
            <text class="btn-text">{{item.is_favorite ? 'å·²æ”¶è—' : 'æ”¶è—'}}</text>
          </button>
          
          <button 
            class="action-btn-with-text"
            data-music="{{item}}"
            catchtap="onShowMusicMenu"
          >
            <view class="btn-icon">
              <image class="action-icon" src="/images/more.svg" mode="aspectFit" />
            </view>
            <text class="btn-text">æ›´å¤š</text>
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- é•¿åºåˆ—è„‘æ³¢åˆ—è¡¨ -->
  <view wx:elif="{{currentTab === 'longSequence'}}" class="content-container">
    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{filteredLongSequenceList.length === 0}}" class="empty-state">
      <image class="empty-icon" src="/images/empty-sequence.svg" mode="aspectFit" />
      
      <!-- è®¿å®¢æ¨¡å¼ -->
      <block wx:if="{{isGuestMode}}">
        <view class="empty-text">è¯·å…ˆç™»å½•æŸ¥çœ‹æ‚¨çš„é•¿åºåˆ—è„‘æ³¢</view>
        <view class="empty-desc">ç™»å½•åå¯æŸ¥çœ‹æ‚¨åˆ›å»ºçš„ä¸“å±é•¿æ—¶é—´AIç–—æ„ˆè„‘æ³¢</view>
        <button class="btn-primary" bindtap="promptLogin">å»ç™»å½•</button>
      </block>
      
      <!-- åœºæ™¯æ¨¡å¼ä¸‹æ— åŒ¹é…è„‘æ³¢ -->
      <block wx:elif="{{isInSceneMode && longSequenceList.length > 0}}">
        <view class="empty-text">å½“å‰åœºæ™¯æš‚æ— ç›¸å…³é•¿åºåˆ—è„‘æ³¢</view>
        <view class="empty-desc">æ‚¨å¯ä»¥åˆ›å»ºæ›´å¤šé•¿åºåˆ—è„‘æ³¢æˆ–é€€å‡ºåœºæ™¯æ¨¡å¼æŸ¥çœ‹å…¨éƒ¨</view>
        <view class="empty-actions">
          <button class="btn-secondary" bindtap="exitSceneMode">æŸ¥çœ‹å…¨éƒ¨è„‘æ³¢</button>
          <button class="btn-primary" bindtap="onGoToCreateSequence">åˆ›å»ºé•¿åºåˆ—</button>
        </view>
      </block>
      
      <!-- æ™®é€šç©ºçŠ¶æ€ -->
      <block wx:else>
        <view class="empty-text">æš‚æ— é•¿åºåˆ—è„‘æ³¢</view>
        <view class="empty-desc">åˆ›å»ºæ‚¨çš„ä¸“å±é•¿æ—¶é—´AIç–—æ„ˆè„‘æ³¢</view>
        <button class="btn-primary" bindtap="onGoToCreateSequence">åˆ›å»ºé•¿åºåˆ—</button>
      </block>
    </view>

    <!-- é•¿åºåˆ—åˆ—è¡¨ -->
    <view wx:else class="sequence-list">
      <view 
        wx:for="{{filteredLongSequenceList}}" 
        wx:key="id"
        class="sequence-item"
        data-sequence="{{item}}"
        bindtap="onPlaySequence"
      >
        <view class="sequence-cover">
          <image
            class="cover-image"
            src="{{item.cover_url || '/images/default-sequence-cover.svg'}}"
            mode="aspectFill"
          />

          <!-- æ’­æ”¾çŠ¶æ€æŒ‡ç¤ºå™¨ -->
          <view wx:if="{{currentPlayingId === item.id && currentPlayingType === 'longSequence'}}" class="playing-indicator">
            <view class="wave wave1"></view>
            <view class="wave wave2"></view>
            <view class="wave wave3"></view>
          </view>
          <view wx:else class="play-overlay">
            <image class="play-icon" src="/images/play-white.svg" mode="aspectFit" />
          </view>
        </view>

        <view class="sequence-info">
          <view class="sequence-title">{{item.title || 'é•¿åºåˆ—ç–—æ„ˆéŸ³é¢‘'}}</view>
          <view class="sequence-meta">
            <text class="sequence-duration">{{formatTime(item.total_duration)}}</text>
            <text class="sequence-segments">{{item.segments_count}}æ®µ</text>
          </view>
          <view class="sequence-description">{{item.description}}</view>
          <view class="sequence-date">{{formatDate(item.created_at)}}</view>
        </view>

        <view class="sequence-actions">
          <button 
            class="action-btn-with-text"
            data-sequence="{{item}}"
            catchtap="onToggleSequenceFavorite"
          >
            <view class="btn-icon">
              <image
                class="action-icon {{item.is_favorite ? 'active' : ''}}"
                src="{{item.is_favorite ? '/images/heart-filled.svg' : '/images/heart.svg'}}"
                mode="aspectFit"
              />
            </view>
            <text class="btn-text">{{item.is_favorite ? 'å·²æ”¶è—' : 'æ”¶è—'}}</text>
          </button>

          <button
            class="action-btn-with-text"
            data-sequence="{{item}}"
            catchtap="onShowSequenceMenu"
          >
            <view class="btn-icon">
              <image class="action-icon" src="/images/more.svg" mode="aspectFit" />
            </view>
            <text class="btn-text">æ›´å¤š</text>
          </button>
        </view>
      </view>
    </view>
  </view>

    <!-- æµ®åŠ¨æ“ä½œæŒ‰é’® -->
    <view class="fab-container">
      <button wx:if="{{currentTab === 'music'}}" class="fab" bindtap="onGoToGenerate">
        <image class="fab-icon" src="/images/add-music.svg" mode="aspectFit" />
      </button>
      <button wx:else class="fab" bindtap="onGoToCreateSequence">
        <image class="fab-icon" src="/images/add-sequence.svg" mode="aspectFit" />
      </button>
    </view>
  </view>
</view>

<!-- ç»Ÿä¸€åº•éƒ¨æ’­æ”¾å™¨ -->
<global-player 
  id="globalPlayer"
  visible="{{showGlobalPlayer}}"
  bind:playStateChange="onGlobalPlayerStateChange"
  bind:nextTrack="onNextTrack"
  bind:previousTrack="onPreviousTrack"
  bind:closePlayer="onCloseGlobalPlayer"
  bind:expandPlayer="onExpandGlobalPlayer"
/>
