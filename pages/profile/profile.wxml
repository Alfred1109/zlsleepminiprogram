<!-- pages/profile/profile.wxml -->
<!-- ä¸ªäººèµ„æ–™é¡µé¢ -->
<!-- ä¸»é¢˜åˆ‡æ¢å™¨ -->
<theme-switcher 
  show-theme-switcher="{{true}}" 
  page-type="default"
  bind:themechange="onThemeChange"
/>
<view class="page-container page-with-tabbar {{themeClass}}">
  <!-- ç”¨æˆ·ä¿¡æ¯å¤´éƒ¨ -->
  <view class="profile-header">
    <view class="user-main-info">
      <view class="user-info">
        <!-- å¤´åƒé€‰æ‹©æŒ‰é’® -->
        <button wx:if="{{isLoggedIn}}" class="avatar-btn" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar">
          <image class="avatar" 
                 src="{{userInfo.avatarUrl || userInfo.avatar_url || '/images/default-avatar.svg'}}"
                 bind:error="onAvatarError"
                 mode="aspectFill"/>
          <view class="avatar-overlay">
            <text class="avatar-tip">ç‚¹å‡»æ›´æ¢</text>
          </view>
        </button>
        <image wx:else 
               class="avatar" 
               src="{{userInfo.avatarUrl || '/images/default-avatar.svg'}}"
               bind:error="onAvatarError"
               mode="aspectFill"/>
        
        <view class="user-detail">
          <!-- æ˜µç§°è¾“å…¥æ¡† -->
          <view class="nickname-row">
            <view wx:if="{{isLoggedIn}}" class="nickname-container">
              <input 
                class="nickname-input" 
                type="nickname" 
                placeholder="ç‚¹å‡»è®¾ç½®æ˜µç§°" 
                value="{{userInfo.nickName || userInfo.nickname || userInfo.username || ''}}"
                bind:blur="onNicknameChange"
                confirm-type="done"
                maxlength="12"
              />
            </view>
            <text wx:else class="nickname">{{userInfo.nickName || userInfo.username || 'æœªç™»å½•'}}</text>
            
            <!-- é€€å‡ºæŒ‰é’®æ”¾åœ¨æ˜µç§°åé¢ -->
            <view wx:if="{{isLoggedIn}}" class="logout-btn-inline">
              <button class="btn btn-secondary btn-mini" bindtap="onLogout">é€€å‡º</button>
            </view>
          </view>
        </view>
      </view>
      
      <!-- å¿«æ·æ“ä½œ -->
      <view class="quick-actions">
        <view wx:if="{{!isLoggedIn}}" class="login-button-container">
          <button class="btn btn-primary btn-medium" bindtap="onLogin">ç™»å½•</button>
        </view>
        <view wx:elif="{{hasChanges || saving}}" class="save-actions">
          <!-- ä¿å­˜æŒ‰é’® -->
          <button wx:if="{{hasChanges && !saving}}" class="btn btn-primary btn-mini" bind:tap="onSaveProfile">
            ä¿å­˜
          </button>
          <!-- è‡ªå®šä¹‰è¿›åº¦æ¡ -->
          <view wx:if="{{saving}}" class="saving-progress-container">
            <view class="progress-bar-container">
              <view class="progress-bar-bg">
                <view class="progress-bar-fill" style="width: {{savingProgress}}%"></view>
                <view class="progress-bar-glow"></view>
              </view>
              <text class="progress-text">ä¿å­˜ä¸­</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ä¼šå‘˜çŠ¶æ€è¯¦ç»†ä¿¡æ¯ -->
    <view wx:if="{{isLoggedIn}}" class="subscription-detail-inline">
      <!-- VIPè§’æ ‡ -->
      <view class="vip-badge-corner">
        <view class="vip-tag-corner" style="background: {{subscriptionStatus.statusColor}};">
          <text class="vip-text">{{subscriptionStatus.displayName}}</text>
          <text class="vip-icon-corner">{{subscriptionStatus.statusIcon}}</text>
        </view>
      </view>
      
      <view class="subscription-info-row">
        <view class="subscription-status-info">
          <view wx:if="{{subscriptionStatus.daysLeft > 0}}" class="subscription-expiry-text">
            å‰©ä½™ {{subscriptionStatus.daysLeft}} å¤©åˆ°æœŸ
          </view>
          <view wx:elif="{{subscriptionStatus.expiresAt}}" class="subscription-expiry-text expired">
            ä¼šå‘˜å·²è¿‡æœŸ
          </view>
          <view wx:else class="subscription-expiry-text">
            äº«å—åŸºç¡€åŠŸèƒ½
          </view>
        </view>
        <view wx:if="{{subscriptionStatus.showUpgrade}}" class="subscription-upgrade-btn">
          <button class="btn-upgrade" bindtap="onUpgradeSubscription">å‡çº§</button>
        </view>
      </view>
      
      <view class="subscription-features">
        <view class="features-grid">
          <view wx:for="{{subscriptionStatus.features}}" wx:key="*this" class="feature-tag">
            <text class="feature-check">âœ“</text>
            <text class="feature-name">{{item}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- é¡µé¢å†…å®¹ -->
  <view class="page-content">

    <!-- ç”¨æˆ·æ•°æ®ç»Ÿè®¡ -->
    <view wx:if="{{isLoggedIn}}" class="content-section">
      <view class="section-header">
        <view class="section-title">æˆ‘çš„æ•°æ®</view>
      </view>

      <view class="stats-container">
        <view class="stats-row">
          <view class="stat-card" bindtap="goToAssessmentHistory">
            <view class="stat-icon">ğŸ“Š</view>
            <view class="stat-content">
              <text class="stat-number">{{stats.assessmentCount}}</text>
              <text class="stat-label">è¯„æµ‹æ¬¡æ•°</text>
            </view>
            <view class="stat-action">æŸ¥çœ‹å†å²</view>
          </view>
          <view class="stat-card">
            <view class="stat-icon">ğŸµ</view>
            <view class="stat-content">
              <text class="stat-number">{{stats.musicCount}}</text>
              <text class="stat-label">ç”ŸæˆéŸ³é¢‘</text>
            </view>
          </view>
        </view>

        <view class="stats-row">
          <view class="stat-card">
            <view class="stat-icon">â°</view>
            <view class="stat-content">
              <text class="stat-number">{{stats.totalListenTime}}</text>
              <text class="stat-label">è†å¬æ—¶é•¿(åˆ†)</text>
            </view>
          </view>
          <view class="stat-card">
            <view class="stat-icon">ğŸ”¥</view>
            <view class="stat-content">
              <text class="stat-number">{{stats.consecutiveDays}}</text>
              <text class="stat-label">è¿ç»­å¤©æ•°</text>
            </view>
          </view>
        </view>
      </view>
    </view>


    <!-- æˆ‘çš„å†…å®¹ -->
    <view class="content-section">
      <view class="section-header">
        <view class="section-title">æˆ‘çš„å†…å®¹</view>
      </view>

      <view class="list-container">
        <!-- è®¾å¤‡ç»‘å®š -->
        <view wx:if="{{isLoggedIn}}" class="list-item" bindtap="goToDeviceBinding">
          <view class="list-item-icon">ğŸ“±</view>
          <view class="list-item-content">
            <view class="list-item-title">è®¾å¤‡ç»‘å®š</view>
          </view>
          <view class="list-item-action">â–¶</view>
        </view>

        <view class="list-item" bindtap="goToFavorites">
          <view class="list-item-icon">â¤ï¸</view>
          <view class="list-item-content">
            <view class="list-item-title">æˆ‘çš„æ”¶è—</view>
          </view>
          <view class="list-item-action">â–¶</view>
        </view>

        <view class="list-item" bindtap="goToDownloads">
          <view class="list-item-icon">ğŸ“¥</view>
          <view class="list-item-content">
            <view class="list-item-title">æˆ‘çš„ä¸‹è½½</view>
          </view>
          <view class="list-item-action">â–¶</view>
        </view>

        <view class="list-item" bindtap="showHistory">
          <view class="list-item-icon">ğŸ•’</view>
          <view class="list-item-content">
            <view class="list-item-title">æ’­æ”¾å†å²</view>
          </view>
          <view class="list-item-action">â–¶</view>
        </view>
      </view>
    </view>

    <!-- æ›´å¤šåŠŸèƒ½ -->
    <view class="content-section">
      <view class="section-header">
        <view class="section-title">æ›´å¤šåŠŸèƒ½</view>
      </view>

      <view class="list-container">
        <view class="list-item" bindtap="showSettings">
          <view class="list-item-icon">âš™ï¸</view>
          <view class="list-item-content">
            <view class="list-item-title">è®¾ç½®</view>
          </view>
          <view class="list-item-action">â–¶</view>
        </view>

        <!-- ä½¿ç”¨å¸®åŠ©å’Œæ„è§åé¦ˆæ¨¡å—å·²ç§»é™¤ -->

        <view class="list-item" bindtap="showAbout">
          <view class="list-item-icon">â„¹ï¸</view>
          <view class="list-item-content">
            <view class="list-item-title">å…³äºæˆ‘ä»¬</view>
          </view>
          <view class="list-item-action">â–¶</view>
        </view>

        <view class="list-item" bindtap="showUserAgreement">
          <view class="list-item-icon">ğŸ“„</view>
          <view class="list-item-content">
            <view class="list-item-title">ç”¨æˆ·åè®®</view>
          </view>
          <view class="list-item-action">â–¶</view>
        </view>

        <view class="list-item" bindtap="showPrivacyPolicy">
          <view class="list-item-icon">ğŸ”’</view>
          <view class="list-item-content">
            <view class="list-item-title">éšç§æ”¿ç­–</view>
          </view>
          <view class="list-item-action">â–¶</view>
        </view>

      </view>
    </view>
  </view>
</view>

<!-- å…¨å±€åº•éƒ¨èœå•æ  -->
<global-tabbar 
  id="globalTabbar"
  current-page="profile"
  theme-class="{{themeClass}}"
  visible="{{true}}"
/>
