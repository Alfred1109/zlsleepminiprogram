<!-- pages/profile/profile.wxml -->
<!-- 个人资料页面 -->
<!-- 主题切换器 -->
<theme-switcher 
  show-theme-switcher="{{true}}" 
  page-type="default"
  bind:themechange="onThemeChange"
/>
<view class="page-container page-with-tabbar {{themeClass}}">
  <!-- 用户信息头部 -->
  <view class="profile-header">
    <view class="user-main-info">
      <view class="user-info">
        <!-- 头像选择按钮 -->
        <button wx:if="{{isLoggedIn}}" class="avatar-btn" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar">
          <image class="avatar" 
                 src="{{userInfo.avatarUrl || userInfo.avatar_url || '/images/default-avatar.svg'}}"
                 bind:error="onAvatarError"
                 mode="aspectFill"/>
          <view class="avatar-overlay">
            <text class="avatar-tip">点击更换</text>
          </view>
        </button>
        <image wx:else 
               class="avatar" 
               src="{{userInfo.avatarUrl || '/images/default-avatar.svg'}}"
               bind:error="onAvatarError"
               mode="aspectFill"/>
        
        <view class="user-detail">
          <!-- 昵称输入框 -->
          <view class="nickname-row">
            <view wx:if="{{isLoggedIn}}" class="nickname-container">
              <input 
                class="nickname-input" 
                type="nickname" 
                placeholder="点击设置昵称" 
                value="{{userInfo.nickName || userInfo.nickname || userInfo.username || ''}}"
                bind:blur="onNicknameChange"
                confirm-type="done"
                maxlength="12"
              />
            </view>
            <text wx:else class="nickname">{{userInfo.nickName || userInfo.username || '未登录'}}</text>
            
            <!-- 退出按钮放在昵称后面 -->
            <view wx:if="{{isLoggedIn}}" class="logout-btn-inline">
              <button class="btn btn-secondary btn-mini" bindtap="onLogout">退出</button>
            </view>
          </view>
        </view>
      </view>
      
      <!-- 快捷操作 -->
      <view class="quick-actions">
        <view wx:if="{{!isLoggedIn}}" class="login-button-container">
          <button class="btn btn-primary btn-medium" bindtap="onLogin">登录</button>
        </view>
        <view wx:elif="{{hasChanges || saving}}" class="save-actions">
          <!-- 保存按钮 -->
          <button wx:if="{{hasChanges && !saving}}" class="btn btn-primary btn-mini" bind:tap="onSaveProfile">
            保存
          </button>
          <!-- 自定义进度条 -->
          <view wx:if="{{saving}}" class="saving-progress-container">
            <view class="progress-bar-container">
              <view class="progress-bar-bg">
                <view class="progress-bar-fill" style="width: {{savingProgress}}%"></view>
                <view class="progress-bar-glow"></view>
              </view>
              <text class="progress-text">保存中</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 会员状态详细信息 -->
    <view wx:if="{{isLoggedIn}}" class="subscription-detail-inline">
      <!-- VIP角标 -->
      <view class="vip-badge-corner">
        <view class="vip-tag-corner" style="background: {{subscriptionStatus.statusColor}};">
          <text class="vip-text">{{subscriptionStatus.displayName}}</text>
          <text class="vip-icon-corner">{{subscriptionStatus.statusIcon}}</text>
        </view>
      </view>
      
      <view class="subscription-info-row">
        <view class="subscription-status-info">
          <view wx:if="{{subscriptionStatus.daysLeft > 0}}" class="subscription-expiry-text">
            剩余 {{subscriptionStatus.daysLeft}} 天到期
          </view>
          <view wx:elif="{{subscriptionStatus.expiresAt}}" class="subscription-expiry-text expired">
            会员已过期
          </view>
          <view wx:else class="subscription-expiry-text">
            享受基础功能
          </view>
        </view>
        <view wx:if="{{subscriptionStatus.showUpgrade}}" class="subscription-upgrade-btn">
          <button class="btn-upgrade" bindtap="onUpgradeSubscription">升级</button>
        </view>
      </view>
      
      <view class="subscription-features">
        <view class="features-grid">
          <view wx:for="{{subscriptionStatus.features}}" wx:key="*this" class="feature-tag">
            <text class="feature-check">✓</text>
            <text class="feature-name">{{item}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 页面内容 -->
  <view class="page-content">

    <!-- 用户数据统计 -->
    <view wx:if="{{isLoggedIn}}" class="content-section">
      <view class="section-header">
        <view class="section-title">我的数据</view>
      </view>

      <view class="stats-container">
        <view class="stats-row">
          <view class="stat-card" bindtap="goToAssessmentHistory">
            <view class="stat-icon">📊</view>
            <view class="stat-content">
              <text class="stat-number">{{stats.assessmentCount}}</text>
              <text class="stat-label">评测次数</text>
            </view>
            <view class="stat-action">查看历史</view>
          </view>
          <view class="stat-card">
            <view class="stat-icon">🎵</view>
            <view class="stat-content">
              <text class="stat-number">{{stats.musicCount}}</text>
              <text class="stat-label">生成音频</text>
            </view>
          </view>
        </view>

        <view class="stats-row">
          <view class="stat-card">
            <view class="stat-icon">⏰</view>
            <view class="stat-content">
              <text class="stat-number">{{stats.totalListenTime}}</text>
              <text class="stat-label">聆听时长(分)</text>
            </view>
          </view>
          <view class="stat-card">
            <view class="stat-icon">🔥</view>
            <view class="stat-content">
              <text class="stat-number">{{stats.consecutiveDays}}</text>
              <text class="stat-label">连续天数</text>
            </view>
          </view>
        </view>
      </view>
    </view>


    <!-- 我的内容 -->
    <view class="content-section">
      <view class="section-header">
        <view class="section-title">我的内容</view>
      </view>

      <view class="list-container">
        <!-- 设备绑定 -->
        <view wx:if="{{isLoggedIn}}" class="list-item" bindtap="goToDeviceBinding">
          <view class="list-item-icon">📱</view>
          <view class="list-item-content">
            <view class="list-item-title">设备绑定</view>
          </view>
          <view class="list-item-action">▶</view>
        </view>

        <view class="list-item" bindtap="goToFavorites">
          <view class="list-item-icon">❤️</view>
          <view class="list-item-content">
            <view class="list-item-title">我的收藏</view>
          </view>
          <view class="list-item-action">▶</view>
        </view>

        <view class="list-item" bindtap="goToDownloads">
          <view class="list-item-icon">📥</view>
          <view class="list-item-content">
            <view class="list-item-title">我的下载</view>
          </view>
          <view class="list-item-action">▶</view>
        </view>

        <view class="list-item" bindtap="showHistory">
          <view class="list-item-icon">🕒</view>
          <view class="list-item-content">
            <view class="list-item-title">播放历史</view>
          </view>
          <view class="list-item-action">▶</view>
        </view>
      </view>
    </view>

    <!-- 更多功能 -->
    <view class="content-section">
      <view class="section-header">
        <view class="section-title">更多功能</view>
      </view>

      <view class="list-container">
        <view class="list-item" bindtap="showSettings">
          <view class="list-item-icon">⚙️</view>
          <view class="list-item-content">
            <view class="list-item-title">设置</view>
          </view>
          <view class="list-item-action">▶</view>
        </view>

        <!-- 使用帮助和意见反馈模块已移除 -->

        <view class="list-item" bindtap="showAbout">
          <view class="list-item-icon">ℹ️</view>
          <view class="list-item-content">
            <view class="list-item-title">关于我们</view>
          </view>
          <view class="list-item-action">▶</view>
        </view>

        <view class="list-item" bindtap="showUserAgreement">
          <view class="list-item-icon">📄</view>
          <view class="list-item-content">
            <view class="list-item-title">用户协议</view>
          </view>
          <view class="list-item-action">▶</view>
        </view>

        <view class="list-item" bindtap="showPrivacyPolicy">
          <view class="list-item-icon">🔒</view>
          <view class="list-item-content">
            <view class="list-item-title">隐私政策</view>
          </view>
          <view class="list-item-action">▶</view>
        </view>

      </view>
    </view>
  </view>
</view>

<!-- 全局底部菜单栏 -->
<global-tabbar 
  id="globalTabbar"
  current-page="profile"
  theme-class="{{themeClass}}"
  visible="{{true}}"
/>
