<!-- pages/profile/profile.wxml -->
<!-- ä¸ªäººèµ„æ–™é¡µé¢ -->
<!-- ä¸»é¢˜åˆ‡æ¢å™¨ -->
<theme-switcher 
  show-theme-switcher="{{true}}" 
  page-type="default"
  bind:themechange="onThemeChange"
/>
<view class="page-container page-with-tabbar {{themeClass}}">
  <!-- ç”¨æˆ·ä¿¡æ¯å¤´éƒ¨ -->
  <view class="profile-header">
    <view class="user-main-info">
      <view class="user-info">
        <!-- å¤´åƒé€‰æ‹©æŒ‰é’® -->
        <button wx:if="{{isLoggedIn}}" class="avatar-btn" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar">
          <image class="avatar" 
                 src="{{userInfo.avatarUrl || userInfo.avatar_url || '/images/default-avatar.svg'}}"
                 bind:error="onAvatarError"
                 mode="aspectFill"/>
          <view class="avatar-overlay">
            <text class="avatar-tip">ç‚¹å‡»æ›´æ¢</text>
          </view>
        </button>
        <image wx:else 
               class="avatar" 
               src="{{userInfo.avatarUrl || '/images/default-avatar.svg'}}"
               bind:error="onAvatarError"
               mode="aspectFill"/>
        
        <view class="user-detail">
          <!-- æ˜µç§°è¾“å…¥æ¡† -->
          <view wx:if="{{isLoggedIn}}" class="nickname-container">
            <input 
              class="nickname-input" 
              type="nickname" 
              placeholder="ç‚¹å‡»è®¾ç½®æ˜µç§°" 
              value="{{userInfo.nickName || userInfo.nickname || userInfo.username || ''}}"
              bind:blur="onNicknameChange"
              confirm-type="done"
              maxlength="12"
            />
          </view>
          <text wx:else class="nickname">{{userInfo.nickName || userInfo.username || 'æœªç™»å½•'}}</text>
          
          <view class="user-status">
            <view wx:if="{{isLoggedIn}}" class="status-badge">
              <text class="vip-tag" style="background: {{subscriptionStatus.statusColor}};">
                <text class="vip-icon">{{subscriptionStatus.statusIcon}}</text>
                {{subscriptionStatus.displayName}}
              </text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- å¿«æ·æ“ä½œ -->
      <view class="quick-actions">
        <view wx:if="{{!isLoggedIn}}" class="login-button-container">
          <button class="btn btn-primary btn-medium" bindtap="onLogin">ç™»å½•</button>
        </view>
        <view wx:else class="action-buttons-container">
          <view class="action-buttons">
            <!-- ä¿å­˜æŒ‰é’® -->
            <button wx:if="{{hasChanges && !saving}}" class="btn btn-primary btn-mini" bind:tap="onSaveProfile">
              ä¿å­˜
            </button>
            <!-- è‡ªå®šä¹‰è¿›åº¦æ¡ -->
            <view wx:if="{{saving}}" class="saving-progress-container">
              <view class="progress-bar-container">
                <view class="progress-bar-bg">
                  <view class="progress-bar-fill" style="width: {{savingProgress}}%"></view>
                  <view class="progress-bar-glow"></view>
                </view>
                <text class="progress-text">ä¿å­˜ä¸­</text>
              </view>
            </view>
            <!-- é€€å‡ºæŒ‰é’® -->
            <button class="btn btn-secondary btn-mini" bindtap="onLogout">é€€å‡º</button>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- é¡µé¢å†…å®¹ -->
  <view class="page-content">

    <!-- ç”¨æˆ·æ•°æ®ç»Ÿè®¡ -->
    <view wx:if="{{isLoggedIn}}" class="content-section">
      <view class="section-header">
        <view class="section-title">æˆ‘çš„æ•°æ®</view>
      </view>

      <view class="stats-container">
        <view class="stats-row">
          <view class="stat-card">
            <view class="stat-icon">ğŸ“Š</view>
            <view class="stat-content">
              <text class="stat-number">{{stats.assessmentCount}}</text>
              <text class="stat-label">è¯„æµ‹æ¬¡æ•°</text>
            </view>
          </view>
          <view class="stat-card">
            <view class="stat-icon">ğŸµ</view>
            <view class="stat-content">
              <text class="stat-number">{{stats.musicCount}}</text>
              <text class="stat-label">ç”ŸæˆéŸ³é¢‘</text>
            </view>
          </view>
        </view>

        <view class="stats-row">
          <view class="stat-card">
            <view class="stat-icon">â°</view>
            <view class="stat-content">
              <text class="stat-number">{{stats.totalListenTime}}</text>
              <text class="stat-label">è†å¬æ—¶é•¿(åˆ†)</text>
            </view>
          </view>
          <view class="stat-card">
            <view class="stat-icon">ğŸ”¥</view>
            <view class="stat-content">
              <text class="stat-number">{{stats.consecutiveDays}}</text>
              <text class="stat-label">è¿ç»­å¤©æ•°</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- è®¢é˜…çŠ¶æ€ -->
    <view wx:if="{{isLoggedIn}}" class="content-section">
      <view class="section-header">
        <view class="section-title">ä¼šå‘˜çŠ¶æ€</view>
      </view>

      <view class="subscription-detail-card">
        <view class="subscription-header">
          <view class="subscription-icon-container">
            <text class="subscription-icon">{{subscriptionStatus.statusIcon}}</text>
          </view>
          <view class="subscription-info">
            <view class="subscription-title" style="color: {{subscriptionStatus.statusColor}}">
              {{subscriptionStatus.displayName}}
            </view>
            <view wx:if="{{subscriptionStatus.daysLeft > 0}}" class="subscription-expiry">
              å‰©ä½™ {{subscriptionStatus.daysLeft}} å¤©åˆ°æœŸ
            </view>
            <view wx:elif="{{subscriptionStatus.expiresAt}}" class="subscription-expiry expired">
              ä¼šå‘˜å·²è¿‡æœŸ
            </view>
            <view wx:else class="subscription-expiry">
              äº«å—åŸºç¡€åŠŸèƒ½
            </view>
          </view>
          <view wx:if="{{subscriptionStatus.showUpgrade}}" class="subscription-action">
            <button class="btn-subscription-upgrade" bindtap="onUpgradeSubscription">å‡çº§</button>
          </view>
        </view>
        
        <view class="subscription-benefits">
          <view class="benefits-title">å¯ç”¨åŠŸèƒ½</view>
          <view class="benefits-grid">
            <view wx:for="{{subscriptionStatus.features}}" wx:key="*this" class="benefit-item">
              <text class="benefit-icon">âœ“</text>
              <text class="benefit-text">{{item}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æˆ‘çš„å†…å®¹ -->
    <view class="content-section">
      <view class="section-header">
        <view class="section-title">æˆ‘çš„å†…å®¹</view>
      </view>

      <view class="list-container">
        <!-- è®¾å¤‡ç»‘å®š -->
        <view wx:if="{{isLoggedIn}}" class="list-item" bindtap="goToDeviceBinding">
          <view class="list-item-icon">ğŸ“±</view>
          <view class="list-item-content">
            <view class="list-item-title">è®¾å¤‡ç»‘å®š</view>
            <view class="list-item-subtitle">ç»‘å®šæ™ºèƒ½è®¾å¤‡ä¸è“ç‰™éŸ³å“</view>
          </view>
          <view class="list-item-action">â–¶</view>
        </view>

        <view class="list-item" bindtap="goToFavorites">
          <view class="list-item-icon">â¤ï¸</view>
          <view class="list-item-content">
            <view class="list-item-title">æˆ‘çš„æ”¶è—</view>
            <view class="list-item-subtitle">æ”¶è—çš„éŸ³é¢‘å’Œè¯„æµ‹</view>
          </view>
          <view class="list-item-action">â–¶</view>
        </view>

        <view class="list-item" bindtap="goToDownloads">
          <view class="list-item-icon">ğŸ“¥</view>
          <view class="list-item-content">
            <view class="list-item-title">æˆ‘çš„ä¸‹è½½</view>
            <view class="list-item-subtitle">å·²ä¸‹è½½çš„éŸ³é¢‘æ–‡ä»¶</view>
          </view>
          <view class="list-item-action">â–¶</view>
        </view>

        <view class="list-item" bindtap="showHistory">
          <view class="list-item-icon">ğŸ•’</view>
          <view class="list-item-content">
            <view class="list-item-title">æ’­æ”¾å†å²</view>
            <view class="list-item-subtitle">æœ€è¿‘æ’­æ”¾çš„éŸ³é¢‘</view>
          </view>
          <view class="list-item-action">â–¶</view>
        </view>
      </view>
    </view>

    <!-- æ›´å¤šåŠŸèƒ½ -->
    <view class="content-section">
      <view class="section-header">
        <view class="section-title">æ›´å¤šåŠŸèƒ½</view>
      </view>

      <view class="list-container">
        <view class="list-item" bindtap="showSettings">
          <view class="list-item-icon">âš™ï¸</view>
          <view class="list-item-content">
            <view class="list-item-title">è®¾ç½®</view>
            <view class="list-item-subtitle">ä¸ªæ€§åŒ–è®¾ç½®å’Œåå¥½</view>
          </view>
          <view class="list-item-action">â–¶</view>
        </view>

        <!-- ä½¿ç”¨å¸®åŠ©å’Œæ„è§åé¦ˆæ¨¡å—å·²ç§»é™¤ -->

        <view class="list-item" bindtap="showAbout">
          <view class="list-item-icon">â„¹ï¸</view>
          <view class="list-item-content">
            <view class="list-item-title">å…³äºæˆ‘ä»¬</view>
            <view class="list-item-subtitle">ç‰ˆæœ¬ 1.0.0</view>
          </view>
          <view class="list-item-action">â–¶</view>
        </view>

        <view class="list-item" bindtap="showUserAgreement">
          <view class="list-item-icon">ğŸ“„</view>
          <view class="list-item-content">
            <view class="list-item-title">ç”¨æˆ·åè®®</view>
            <view class="list-item-subtitle">æœåŠ¡æ¡æ¬¾ä¸ä½¿ç”¨åè®®</view>
          </view>
          <view class="list-item-action">â–¶</view>
        </view>

        <view class="list-item" bindtap="showPrivacyPolicy">
          <view class="list-item-icon">ğŸ”’</view>
          <view class="list-item-content">
            <view class="list-item-title">éšç§æ”¿ç­–</view>
            <view class="list-item-subtitle">éšç§ä¿æŠ¤ä¸æ•°æ®å®‰å…¨</view>
          </view>
          <view class="list-item-action">â–¶</view>
        </view>

      </view>
    </view>
  </view>
</view>

<!-- å…¨å±€åº•éƒ¨èœå•æ  -->
<global-tabbar 
  id="globalTabbar"
  current-page="profile"
  theme-class="{{themeClass}}"
  visible="{{true}}"
/>
