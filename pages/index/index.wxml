<!-- pages/index/index.wxml -->
<!-- 主题切换器 -->
<theme-switcher 
  show-theme-switcher="{{true}}" 
  page-type="home"
  bind:themechange="onThemeChange"
  bind:toggleplayer="onToggleGlobalPlayer"
/>

<view class="container page-with-tabbar {{themeClass}}">
  <!-- 顶部Logo区域 -->
  <view class="header-section">
    <view class="logo-container">
      <image class="logo-image" src="/images/logo.png" mode="aspectFit" />
      <text class="logo-subtitle">AI疗愈脑波</text>
    </view>
  </view>

  <!-- 用户信息展示模块 -->
  <view class="user-info-section">
    <!-- 未登录状态 -->
    <view class="user-card login-prompt-card" wx:if="{{!isLoggedIn}}" bindtap="goToLogin">
      <view class="user-avatar">
        <text class="avatar-icon">👋</text>
      </view>
      <view class="user-details">
        <text class="user-name">点击登录</text>
        <text class="user-status">登录后享受个性化疗愈体验</text>
      </view>
      <view class="user-action">
        <text class="action-arrow">→</text>
      </view>
    </view>

    <!-- 已登录状态 -->
    <view class="user-card" wx:else>
      <view class="user-avatar">
        <image class="avatar-image" 
               src="{{userInfo.avatar || userInfo.avatarUrl || userInfo.avatar_url || '/images/default-avatar.svg'}}" 
               wx:if="{{userInfo.avatar || userInfo.avatarUrl || userInfo.avatar_url}}"
               bind:error="onAvatarError"
               mode="aspectFill" />
        <text class="avatar-icon" wx:else>{{subscriptionStatus.statusIcon || '👤'}}</text>
      </view>
      <view class="user-details">
        <text class="user-name">{{userInfo.nickname || userInfo.name || '用户'}}</text>
        <view class="user-status">
          <!-- 已订阅状态 -->
          <text class="status-text subscribed" wx:if="{{unifiedStatus.isSubscribed}}" style="color: {{subscriptionStatus.statusColor}}">
            {{subscriptionStatus.displayName}} · {{subscriptionStatus.description}}
          </text>
          <!-- 试用状态 -->
          <text class="status-text trial" wx:elif="{{unifiedStatus.isInTrial}}" style="color: {{subscriptionStatus.statusColor}}">
            {{subscriptionStatus.displayName}} · {{subscriptionStatus.description}}
          </text>
          <!-- 免费用户 -->
          <text class="status-text free" wx:else>
            {{subscriptionStatus.description || '免费版用户'}}
          </text>
          
          <!-- 设备绑定状态 -->
          <view class="device-status">
            <view wx:if="{{loadingDeviceStatus}}" class="device-loading">
              <text class="loading-text">检查设备状态...</text>
            </view>
            <view wx:elif="{{hasBindedDevice}}" class="device-info bound">
              <image class="device-icon" src="/images/check.svg" mode="aspectFit" />
              <text class="device-text">已绑定 {{bindedDeviceCount}} 台设备</text>
            </view>
            <view wx:else class="device-info unbound" bindtap="goToDeviceBinding">
              <image class="device-icon" src="/images/phone-icon.svg" mode="aspectFit" />
              <text class="device-text">未绑定设备</text>
              <text class="device-action">绑定设备 →</text>
            </view>
          </view>
        </view>
      </view>
      <!-- 订阅引导按钮 -->
      <view class="user-action" wx:if="{{subscriptionStatus.showUpgrade}}" bindtap="goToSubscription">
        <text class="upgrade-text">升级</text>
      </view>
      <!-- 已订阅用户显示状态图标 -->
      <view class="user-action" wx:else>
        <text class="status-icon" style="color: {{subscriptionStatus.statusColor}}">{{subscriptionStatus.statusIcon}}</text>
      </view>
    </view>
  </view>

  <!-- 疗愈场景 -->
  <view class="section-header">
    <text class="section-title">疗愈场景</text>
    <view class="section-actions">
      <view class="section-more" bindtap="showAllScenes">查看全部</view>
    </view>
  </view>
  
  <!-- 疗愈场景布局 - 方块形式 -->
  <view class="scene-categories scene-grid">
    <view wx:for="{{categories}}" wx:key="id" 
          class="scene-category-card" 
          bindtap="onSceneTap" 
          data-id="{{item.id}}"
          data-name="{{item.name}}"
          data-scale-type="{{item.scaleType}}"
          data-scene-name="{{item.sceneName}}"
          data-index="{{index}}">
      <view class="scene-card-icon category-icon-{{item.id}}">
        <text class="category-emoji">{{item.icon || '🎯'}}</text>
      </view>
      <view class="scene-card-info">
        <text class="scene-card-name">{{item.name || '未知场景'}}</text>
        <text class="scene-card-desc">{{item.description || '疗愈场景'}}</text>
      </view>
    </view>
  </view>



  <!-- 场景使用提示 -->
  <view class="usage-tip">
    <view class="tip-icon">🎯</view>
    <view class="tip-content">
      <text class="tip-title">开始您的疗愈之旅</text>
      <text class="tip-desc">点击场景卡片，查看评测记录并开始个性化疗愈</text>
    </view>
  </view>
</view>

<!-- 统一底部播放器 -->
<global-player 
  id="globalPlayer"
  visible="{{showGlobalPlayer}}"
  bind:playStateChange="onGlobalPlayerStateChange"
  bind:nextTrack="onNextTrack"
  bind:previousTrack="onPreviousTrack"
  bind:closePlayer="onCloseGlobalPlayer"
  bind:expandPlayer="onExpandGlobalPlayer"
/>

<!-- 全局底部菜单栏 -->
<global-tabbar 
  id="globalTabbar"
  current-page="index"
  theme-class="{{themeClass}}"
  visible="{{true}}"
/>
