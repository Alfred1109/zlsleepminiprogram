<!-- pages/index/index.wxml -->
<view class="container">
  <!-- é¡¶éƒ¨LogoåŒºåŸŸ -->
  <view class="header-section">
    <view class="logo-container">
      <text class="logo-text">medsleep</text>
      <text class="logo-subtitle">AIç–—æ„ˆè„‘æ³¢</text>
    </view>
  </view>

  <!-- æ–°ç‰ˆå¼•å¯¼åŠŸèƒ½åŒº -->
  <view class="guide-section">
    <!-- æ¨¡å—ä¸€ï¼šéšæœºæ’­æ”¾ -->
    <view class="guide-card random-listen" bindtap="onRandomListen">
      <view class="card-content">
        <text class="card-title">éšæœºæ’­æ”¾</text>
        <text class="card-desc">â€”â€”æ¢ç´¢ä¸ºæ‚¨ç²¾é€‰çš„ç–—æ„ˆè„‘æ³¢</text>
      </view>
      <view class="card-action">
        <image class="play-icon" src="/images/play-white.svg" />
      </view>
    </view>

    <!-- æ¨¡å—äºŒï¼šä¸“ä¸šè¯„æµ‹ -->
    <view class="guide-card assessment-card" bindtap="navigateToAssessment">
      <view class="card-header">
        <text class="card-title">ä¸“ä¸šè¯„æµ‹</text>
        <view class="card-action-button">å¼€å§‹è¯„æµ‹</view>
      </view>
      <view class="card-body">
        <view class="history-list" wx:if="{{assessmentHistory.length > 0}}">
          <view class="history-item" wx:for="{{assessmentHistory}}" wx:key="id">
            <view class="history-info">
              <text class="history-name">{{item.scaleName}} Â· {{item.result}}</text>
              <text class="history-date">{{item.date}}</text>
            </view>
            <view class="assessment-view-button" data-id="{{item.id}}" catchtap="viewAssessmentResult">
              <text class="view-text">æŸ¥çœ‹æŠ¥å‘Š</text>
            </view>
          </view>
        </view>
        <view class="empty-history" wx:else>
          <image class="empty-icon" src="/images/empty-assessment.svg" />
          <text class="empty-history-text">æš‚æ— è¯„æµ‹è®°å½•</text>
        </view>
      </view>
    </view>

    <!-- æ¨¡å—ä¸‰ï¼šè‡ªå®šä¹‰è„‘æ³¢ -->
    <view class="guide-card brainwave-card" bindtap="navigateToGenerator">
      <view class="card-header">
        <text class="card-title">AIç”Ÿæˆè„‘æ³¢</text>
        <view class="card-action-button">ç«‹å³ç”Ÿæˆ</view>
      </view>
      <view class="card-body">

        <view class="history-list" wx:if="{{brainwaveHistory.length > 0}}">
          <view class="history-item" wx:for="{{brainwaveHistory}}" wx:key="id">
            <view class="history-info">
              <text class="history-name">{{item.name}}</text>
              <view class="history-meta">
                <text class="history-date">{{item.date}}</text>
                <text class="history-type {{item.type === '60s_generated' ? 'type-60s' : 'type-long'}}">
                  {{item.type === '60s_generated' ? '60ç§’å®šåˆ¶' : 'é•¿åºåˆ—'}}
                </text>
              </view>
            </view>
            <view class="play-button" data-music="{{item}}" catchtap="playHistoryBrainwave">
              <image class="play-icon-small" src="/images/play.svg" />
            </view>
          </view>
        </view>
        <view class="empty-history" wx:else>
          <image class="empty-icon" src="/images/empty-music.svg" />
          <text class="empty-history-text">æš‚æ— ç”Ÿæˆè®°å½•</text>
          <view style="margin-top: 20rpx; padding: 20rpx; background: rgba(255,255,255,0.2); border-radius: 8rpx; font-size: 20rpx;">
            <view style="display: flex; flex-direction: column; gap: 8rpx;">
              <text style="color: #64766A;">ğŸ” è°ƒè¯•ä¿¡æ¯:</text>
              <text style="color: #374151;">ç™»å½•çŠ¶æ€: {{isLoggedIn ? 'âœ… å·²ç™»å½•' : 'âŒ æœªç™»å½•'}}</text>
              <text style="color: #374151;">ç”¨æˆ·ID: {{userInfo.id || userInfo.user_id || 'æ— '}}</text>
              <text style="color: #374151;">è„‘æ³¢æ•°æ®: {{brainwaveHistory.length}}æ¡</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç–—æ„ˆåˆ†ç±» -->
  <view class="section-header">
    <text class="section-title">ç–—æ„ˆåˆ†ç±»</text>
    <view class="section-actions">
      <view class="section-more" bindtap="showAllCategories">æŸ¥çœ‹å…¨éƒ¨</view>
    </view>
  </view>
  
  <!-- ä¸‰ä¸ªåˆ†ç±»ä¸€æ’å¸ƒå±€ -->
  <view class="sound-categories">
    <view wx:for="{{categories}}" wx:key="id" 
          class="sound-category-item {{selectedCategory === item.id ? 'selected' : ''}}" 
          bindtap="onCategoryTap" 
          data-id="{{item.id}}"
          data-name="{{item.name}}"
          data-index="{{index}}">
      <view class="sound-category-icon category-icon-{{item.id}}">
        <text class="category-emoji">{{item.icon || 'ğŸµ'}}</text>
      </view>
      <text class="category-name">{{item.name || 'æœªçŸ¥åˆ†ç±»'}}</text>
      <text class="category-count" wx:if="{{item.count > 0}}">{{item.count}}é¦–</text>
    </view>
  </view>



  <!-- åˆ†ç±»æ¨èè„‘æ³¢åŒºåŸŸ -->
  <view class="category-recommendations" wx:if="{{selectedCategory && categoryRecommendations.length > 0}}">
    <view class="section-header">
      <text class="section-title">{{getCategoryName(selectedCategory)}} Â· æ¨è</text>
    </view>
    
    <!-- å‚ç›´æ’åˆ—çš„æ¨èåˆ—è¡¨ -->
    <view class="recommendations-vertical-list">
      <view wx:for="{{categoryRecommendations}}" wx:key="id" wx:if="{{index < 3}}"
            class="recommendation-vertical-item {{playingSoundId === item.id ? 'playing' : ''}}"
            bindtap="onRecommendationTap"
            data-music="{{item}}">
        
        <!-- è„‘æ³¢å°é¢ -->
        <view class="music-cover-vertical">
          <image 
            class="cover-image-vertical" 
            src="{{item.image || '/images/default-music-cover.svg'}}" 
            mode="aspectFill"
          />
        </view>
        
        <!-- è„‘æ³¢ä¿¡æ¯ -->
        <view class="music-info-vertical">
          <text class="music-title-vertical">{{item.title}}</text>
          <text class="music-duration-vertical" wx:if="{{item.duration}}">{{formatDuration(item.duration)}}</text>
        </view>
        
        <!-- æ’­æ”¾æŒ‰é’® -->
        <view class="play-button-vertical" 
              catchtap="onPlayRecommendation" 
              data-music="{{item}}">
          <text class="play-icon-vertical">â–¶</text>
        </view>
      </view>
    </view>
  </view>



  <!-- ä½¿ç”¨æç¤º -->
  <view class="usage-tip" wx:if="{{!selectedCategory}}">
    <view class="tip-icon">ğŸ’¡</view>
    <view class="tip-content">
      <text class="tip-title">å¼€å§‹æ‚¨çš„ç–—æ„ˆä¹‹æ—…</text>
      <text class="tip-desc">é€‰æ‹©ä¸€ä¸ªåˆ†ç±»ï¼ŒæŸ¥çœ‹æ¨èè„‘æ³¢å¹¶å¼€å§‹æ’­æ”¾</text>
    </view>
  </view>
</view>

<!-- ç»Ÿä¸€åº•éƒ¨æ’­æ”¾å™¨ -->
<global-player 
  id="globalPlayer"
  visible="{{showGlobalPlayer}}"
  bind:playStateChange="onGlobalPlayerStateChange"
  bind:nextTrack="onNextTrack"
  bind:previousTrack="onPreviousTrack"
  bind:closePlayer="onCloseGlobalPlayer"
  bind:expandPlayer="onExpandGlobalPlayer"
/>
