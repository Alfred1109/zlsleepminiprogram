<!-- pages/index/index.wxml -->
<!-- ä¸»é¢˜åˆ‡æ¢å™¨ -->
<theme-switcher 
  show-theme-switcher="{{true}}" 
  page-type="home"
  bind:themechange="onThemeChange"
  bind:toggleplayer="onToggleGlobalPlayer"
/>

<view class="container page-with-tabbar {{themeClass}}">
  <!-- é¡¶éƒ¨LogoåŒºåŸŸ -->
  <view class="header-section">
    <view class="logo-container">
      <image class="logo-image" src="/images/logo.png" mode="aspectFit" />
      <text class="logo-subtitle">AIç–—æ„ˆè„‘æ³¢</text>
    </view>
    <view class="header-actions">
      <button class="share-btn" open-type="share">
        <image class="share-icon" src="/images/share.svg" mode="aspectFit" />
      </button>
    </view>
  </view>

  <!-- ç”¨æˆ·ä¿¡æ¯å±•ç¤ºæ¨¡å— -->
  <view class="user-info-section">
    <!-- æœªç™»å½•çŠ¶æ€ -->
    <view class="user-card login-prompt-card" wx:if="{{!isLoggedIn}}" bindtap="goToLogin">
      <view class="user-avatar">
        <text class="avatar-icon">ğŸ‘‹</text>
      </view>
      <view class="user-details">
        <text class="user-name">ç‚¹å‡»ç™»å½•</text>
        <text class="user-desc">ç™»å½•åäº«å—ä¸ªæ€§åŒ–ç–—æ„ˆä½“éªŒ</text>
      </view>
      <view class="user-action">
        <text class="action-arrow">â†’</text>
      </view>
    </view>

    <!-- å·²ç™»å½•çŠ¶æ€ -->
    <view class="user-card unified-card" wx:else>
      <!-- ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ -->
      <view class="user-basic-info">
        <view class="user-avatar">
          <image class="avatar-image" 
                 src="{{userInfo.avatar || userInfo.avatarUrl || userInfo.avatar_url || '/images/default-avatar.svg'}}" 
                 wx:if="{{userInfo.avatar || userInfo.avatarUrl || userInfo.avatar_url}}"
                 bind:error="onAvatarError"
                 mode="aspectFill" />
          <text class="avatar-icon" wx:else>{{subscriptionStatus.statusIcon || 'ğŸ‘¤'}}</text>
        </view>
        <view class="user-details">
          <text class="user-name">{{userInfo.nickname || userInfo.name || 'ç”¨æˆ·'}}</text>
          <text class="user-desc">æ¬¢è¿å›æ¥ï¼Œå¼€å§‹ä»Šæ—¥çš„ç–—æ„ˆä¹‹æ—…</text>
        </view>
        <!-- è®¢é˜…çŠ¶æ€å›¾æ ‡ -->
        <view class="user-action">
          <view class="status-badge" style="background-color: {{subscriptionStatus.statusColor}};">
            <text class="status-icon">{{subscriptionStatus.statusIcon}}</text>
          </view>
        </view>
      </view>

      <!-- è®¢é˜…çŠ¶æ€åŒºåŸŸ -->
      <view class="subscription-section">
        <view class="subscription-info">
          <view class="subscription-status">
            <text class="subscription-title">{{subscriptionStatus.displayName}}</text>
            <text class="subscription-desc">{{subscriptionStatus.description}}</text>
          </view>
          <view class="subscription-action" wx:if="{{subscriptionStatus.showUpgrade}}" bindtap="goToSubscription">
            <text class="upgrade-text">å‡çº§</text>
          </view>
        </view>
      </view>

      <!-- è®¾å¤‡çŠ¶æ€åŒºåŸŸ -->
      <view class="device-section">
        <view class="device-header">
          <image class="device-header-icon" src="/images/phone-icon.svg" mode="aspectFit" />
          <text class="device-header-title">æˆ‘çš„è®¾å¤‡</text>
        </view>
        
        <view class="device-content">
          <!-- åŠ è½½çŠ¶æ€ -->
          <view wx:if="{{loadingDeviceStatus}}" class="device-loading">
            <text class="loading-text">æ£€æŸ¥è®¾å¤‡çŠ¶æ€...</text>
          </view>
          
          <!-- å·²ç»‘å®šè®¾å¤‡ -->
          <view wx:elif="{{hasBindedDevice}}" class="device-bound">
            <view class="device-status-info">
              <image class="device-status-icon" src="/images/check.svg" mode="aspectFit" />
              <text class="device-status-text">å·²ç»‘å®š {{bindedDeviceCount}} å°è®¾å¤‡</text>
            </view>
            <view class="device-actions">
              <button class="device-btn secondary" bindtap="goToDeviceBinding">ç®¡ç†è®¾å¤‡</button>
              <button class="device-btn primary" bindtap="goToPurchaseDevice">è´­ä¹°æ›´å¤š</button>
            </view>
          </view>
          
          <!-- æœªç»‘å®šè®¾å¤‡ -->
          <view wx:else class="device-unbound">
            <view class="device-status-info">
              <image class="device-status-icon" src="/images/phone-icon.svg" mode="aspectFit" />
              <text class="device-status-text">æš‚æœªç»‘å®šè®¾å¤‡</text>
            </view>
            <view class="device-actions">
              <button class="device-btn secondary" bindtap="goToDeviceBinding">ç»‘å®šè®¾å¤‡</button>
              <button class="device-btn primary" bindtap="goToPurchaseDevice">è´­ä¹°è®¾å¤‡</button>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç–—æ„ˆåœºæ™¯ -->
  <view class="section-header">
    <text class="section-title">ç–—æ„ˆåœºæ™¯</text>
    <view class="section-actions">
      <view class="section-more" bindtap="showAllScenes">æŸ¥çœ‹å…¨éƒ¨</view>
    </view>
  </view>
  
  <!-- ç–—æ„ˆåœºæ™¯å¸ƒå±€ - æ–¹å—å½¢å¼ -->
  <view class="scene-categories scene-grid">
    <view wx:for="{{categories}}" wx:key="id" 
          class="scene-category-card" 
          bindtap="onSceneTap" 
          data-id="{{item.id}}"
          data-name="{{item.name}}"
          data-scale-type="{{item.scaleType}}"
          data-scene-name="{{item.sceneName}}"
          data-index="{{index}}">
      <view class="scene-card-icon category-icon-{{item.id}}">
        <text class="category-emoji">{{item.icon || 'ğŸ¯'}}</text>
      </view>
      <view class="scene-card-info">
        <text class="scene-card-name">{{item.name || 'æœªçŸ¥åœºæ™¯'}}</text>
        <text class="scene-card-desc">{{item.description || 'ç–—æ„ˆåœºæ™¯'}}</text>
      </view>
    </view>
  </view>



  <!-- ç–—æ„ˆå•†å“æ¨è -->
  <view class="section-header">
    <text class="section-title">ç–—æ„ˆå•†å“</text>
    <view class="section-actions">
      <view class="section-more" bindtap="goToProductList">æŸ¥çœ‹å…¨éƒ¨</view>
    </view>
  </view>
</view>

<!-- ç»Ÿä¸€åº•éƒ¨æ’­æ”¾å™¨ -->
<global-player 
  id="globalPlayer"
  visible="{{showGlobalPlayer}}"
  bind:playStateChange="onGlobalPlayerStateChange"
  bind:nextTrack="onNextTrack"
  bind:previousTrack="onPreviousTrack"
  bind:closePlayer="onCloseGlobalPlayer"
  bind:expandPlayer="onExpandGlobalPlayer"
/>

<!-- å…¨å±€åº•éƒ¨èœå•æ  -->
<global-tabbar 
  id="globalTabbar"
  current-page="index"
  theme-class="{{themeClass}}"
  visible="{{true}}"
/>
