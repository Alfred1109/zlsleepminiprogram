<!--pages/assessment/scales/scales.wxml-->
<!-- 评测量表选择页面 -->
<!-- 主题切换器 -->
<theme-switcher 
  show-theme-switcher="{{true}}" 
  page-type="default"
  bind:themechange="onThemeChange"
/>
<view class="page-container page-with-tabbar {{themeClass}}">

  <!-- 场景状态指示器 -->
  <view wx:if="{{isInSceneMode}}" class="scene-indicator">
    <view class="scene-indicator-content">
      <view class="scene-indicator-icon">🎯</view>
      <view class="scene-indicator-text">
        <text class="scene-indicator-title">{{sceneHint}}</text>
        <text class="scene-indicator-subtitle">只显示相关评测量表</text>
      </view>
      <view class="scene-indicator-action" bindtap="exitSceneMode">
        <text class="exit-text">全部场景</text>
      </view>
    </view>
  </view>

  <!-- 页面内容 -->
  <view class="page-content">
    <!-- 加载状态 -->
    <view wx:if="{{loading}}" class="loading-container">
      <view class="loading-spinner"></view>
      <view class="loading-text">加载评测量表中...</view>
    </view>

    <!-- 评测量表列表 -->
    <view wx:else>
      <view class="content-section">
        <view class="section-header">
          <view class="section-title">选择评测量表</view>
          <view wx:if="{{isInSceneMode}}" class="section-subtitle">
            共 {{filteredScales.length}} 个相关量表
          </view>
        </view>

        <!-- 量表列表 -->
        <view wx:if="{{filteredScales.length > 0}}" class="list-container">
          <view
            wx:for="{{filteredScales}}"
            wx:key="scale_id"
            class="list-item"
            data-scale="{{item}}"
            bindtap="onStartAssessment"
          >
            <view class="list-item-icon">{{item.icon}}</view>
            <view class="list-item-content">
              <view class="list-item-title">{{item.scale_name || '心理评测'}}</view>
              <view class="list-item-subtitle">{{item.scale_type}}</view>
              <view class="card-content">{{item.description}}</view>
              <view class="list-item-meta">
                ⏱️ {{item.estimatedTime}} · 📝 {{item.question_count}}题
              </view>
            </view>
            <view class="list-item-action">
              <text style="color: #5D9E7E; font-size: 24rpx;">▶</text>
            </view>
          </view>
        </view>

        <!-- 空状态 -->
        <view wx:else class="empty-state">
          <view class="empty-icon">📋</view>
          <view class="empty-title">
            {{isInSceneMode ? '暂无相关评测量表' : '暂无评测量表'}}
          </view>
          <view class="empty-subtitle">
            {{isInSceneMode ? '当前场景暂无对应的评测量表' : '请稍后重试或联系客服'}}
          </view>
          <view wx:if="{{isInSceneMode}}" class="empty-action">
            <button class="empty-button" bindtap="exitSceneMode">查看所有量表</button>
          </view>
        </view>
      </view>

      <!-- 评测趋势 -->
      <view wx:if="{{recentAssessments.length > 0}}" class="content-section">
        <view class="section-header">
          <view class="section-title">评测趋势</view>
          <view class="section-action" bindtap="onViewHistory">查看历史</view>
        </view>

        <!-- 趋势图卡片 -->
        <view class="trend-card">
          <!-- 趋势概览 -->
          <view class="trend-overview">
            <view class="trend-stats">
              <view class="trend-stat">
                <text class="stat-value">{{recentAssessments.length}}</text>
                <text class="stat-label">总评测</text>
              </view>
              <view class="trend-stat">
                <text class="stat-value">{{latestScore || '--'}}</text>
                <text class="stat-label">最新分数</text>
              </view>
              <view class="trend-stat">
                <text class="stat-value">{{trendDirection}}</text>
                <text class="stat-label">趋势</text>
              </view>
            </view>
          </view>
          
          <!-- 简化趋势图 -->
          <view wx:if="{{trendData.length > 0}}" class="simple-chart">
            <view class="chart-title">评测分数趋势（最近7次）</view>
            <view class="chart-container">
              <view class="chart-grid">
                <!-- 网格线 -->
                <view class="grid-line" wx:for="{{5}}" wx:key="*this" style="bottom: {{item * 20}}%"></view>
              </view>
              <view class="chart-line">
                <!-- 趋势点 -->
                <view class="trend-point" 
                      wx:for="{{trendData}}" 
                      wx:key="index"
                      style="left: {{item.x}}%; bottom: {{item.y}}%"
                      data-score="{{item.score}}"
                      data-date="{{item.date}}">
                  <view class="point-dot {{item.isLatest ? 'latest' : ''}}"></view>
                  <view class="point-label">{{item.score}}</view>
                </view>
                <!-- 连接线 -->
                <view class="trend-line" wx:if="{{trendData.length > 1}}">
                  <svg class="line-svg" viewBox="0 0 100 100" preserveAspectRatio="none">
                    <polyline points="{{trendLinePoints}}" 
                              fill="none" 
                              stroke="#4A90E2" 
                              stroke-width="2"
                              stroke-linecap="round"
                              stroke-linejoin="round"/>
                  </svg>
                </view>
              </view>
            </view>
            <view class="chart-labels">
              <text class="label-left">最早</text>
              <text class="label-right">最新</text>
            </view>
          </view>
          
          <!-- 最新评测结果 -->
          <view wx:if="{{latestAssessment}}" class="latest-result">
            <view class="result-header">
              <text class="result-title">最新评测</text>
              <text class="result-date">{{latestAssessment.date}}</text>
            </view>
            <view class="result-content">
              <view class="result-score">
                <text class="score-number">{{latestAssessment.total_score || latestAssessment.result}}</text>
                <text class="score-unit">分</text>
              </view>
              <view class="result-info">
                <text class="result-name">{{latestAssessment.scale_name}}</text>
                <text class="result-status">{{latestAssessment.result}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- 评测说明 -->
      <view class="content-section">
        <view class="section-header">
          <view class="section-title">评测说明</view>
        </view>

        <view class="card">
          <view class="info-content">
            <view class="info-item">📋 请在安静的环境中完成评测</view>
            <view class="info-item">🎯 根据最近一周的感受如实作答</view>
            <view class="info-item">⚠️ 评测结果仅供参考，不作为诊断依据</view>
            <view class="info-item">🎵 完成评测后可生成个性化疗愈音乐</view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- 全局底部菜单栏 -->
<global-tabbar 
  id="globalTabbar"
  current-page="assessment"
  theme-class="{{themeClass}}"
  visible="{{true}}"
/>
