<!--pages/assessment/scales/scales.wxml-->
<!-- è¯„æµ‹é‡è¡¨é€‰æ‹©é¡µé¢ -->
<!-- ä¸»é¢˜åˆ‡æ¢å™¨ -->
<theme-switcher 
  show-theme-switcher="{{true}}" 
  page-type="default"
  bind:themechange="onThemeChange"
/>
<view class="page-container page-with-tabbar {{themeClass}}">

  <!-- åœºæ™¯çŠ¶æ€æŒ‡ç¤ºå™¨ -->
  <view wx:if="{{isInSceneMode}}" class="scene-indicator">
    <view class="scene-indicator-content">
      <view class="scene-indicator-icon">ğŸ¯</view>
      <view class="scene-indicator-text">
        <text class="scene-indicator-title">{{sceneHint}}</text>
        <text class="scene-indicator-subtitle">åªæ˜¾ç¤ºç›¸å…³è¯„æµ‹é‡è¡¨</text>
      </view>
      <view class="scene-indicator-action" bindtap="exitSceneMode">
        <text class="exit-text">å…¨éƒ¨åœºæ™¯</text>
      </view>
    </view>
  </view>

  <!-- é¡µé¢å†…å®¹ -->
  <view class="page-content">
    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{loading}}" class="loading-container">
      <view class="loading-spinner"></view>
      <view class="loading-text">åŠ è½½è¯„æµ‹é‡è¡¨ä¸­...</view>
    </view>

    <!-- è¯„æµ‹é‡è¡¨åˆ—è¡¨ -->
    <view wx:else>
      <view class="content-section">
        <view class="section-header">
          <view class="section-title">é€‰æ‹©è¯„æµ‹é‡è¡¨</view>
          <view wx:if="{{isInSceneMode}}" class="section-subtitle">
            å…± {{filteredScales.length}} ä¸ªç›¸å…³é‡è¡¨
          </view>
        </view>

        <!-- é‡è¡¨åˆ—è¡¨ -->
        <view wx:if="{{filteredScales.length > 0}}" class="list-container">
          <view
            wx:for="{{filteredScales}}"
            wx:key="scale_id"
            class="list-item"
            data-scale="{{item}}"
            bindtap="onStartAssessment"
          >
            <view class="list-item-icon">{{item.icon}}</view>
            <view class="list-item-content">
              <view class="list-item-title">{{item.scale_name || 'å¿ƒç†è¯„æµ‹'}}</view>
              <view class="list-item-subtitle">{{item.scale_type}}</view>
              <view class="card-content">{{item.description}}</view>
              <view class="list-item-meta">
                â±ï¸ {{item.estimatedTime}} Â· ğŸ“ {{item.question_count}}é¢˜
              </view>
            </view>
            <view class="list-item-action">
              <text style="color: #5D9E7E; font-size: 24rpx;">â–¶</text>
            </view>
          </view>
        </view>

        <!-- ç©ºçŠ¶æ€ -->
        <view wx:else class="empty-state">
          <view class="empty-icon">ğŸ“‹</view>
          <view class="empty-title">
            {{isInSceneMode ? 'æš‚æ— ç›¸å…³è¯„æµ‹é‡è¡¨' : 'æš‚æ— è¯„æµ‹é‡è¡¨'}}
          </view>
          <view class="empty-subtitle">
            {{isInSceneMode ? 'å½“å‰åœºæ™¯æš‚æ— å¯¹åº”çš„è¯„æµ‹é‡è¡¨' : 'è¯·ç¨åé‡è¯•æˆ–è”ç³»å®¢æœ'}}
          </view>
          <view wx:if="{{isInSceneMode}}" class="empty-action">
            <button class="empty-button" bindtap="exitSceneMode">æŸ¥çœ‹æ‰€æœ‰é‡è¡¨</button>
          </view>
        </view>
      </view>

      <!-- è¯„æµ‹è¶‹åŠ¿ -->
      <view wx:if="{{recentAssessments.length > 0}}" class="content-section">
        <view class="section-header">
          <view class="section-title">è¯„æµ‹è¶‹åŠ¿</view>
          <view class="section-action" bindtap="onViewHistory">æŸ¥çœ‹å†å²</view>
        </view>

        <!-- è¶‹åŠ¿å›¾å¡ç‰‡ -->
        <view class="trend-card">
          <!-- è¶‹åŠ¿æ¦‚è§ˆ -->
          <view class="trend-overview">
            <view class="trend-stats">
              <view class="trend-stat">
                <text class="stat-value">{{recentAssessments.length}}</text>
                <text class="stat-label">æ€»è¯„æµ‹</text>
              </view>
              <view class="trend-stat">
                <text class="stat-value">{{latestScore || '--'}}</text>
                <text class="stat-label">æœ€æ–°åˆ†æ•°</text>
              </view>
              <view class="trend-stat">
                <text class="stat-value">{{trendDirection}}</text>
                <text class="stat-label">è¶‹åŠ¿</text>
              </view>
            </view>
          </view>
          
          <!-- ç®€åŒ–è¶‹åŠ¿å›¾ -->
          <view wx:if="{{trendData.length > 0}}" class="simple-chart">
            <view class="chart-title">è¯„æµ‹åˆ†æ•°è¶‹åŠ¿ï¼ˆæœ€è¿‘7æ¬¡ï¼‰</view>
            <view class="chart-container">
              <view class="chart-grid">
                <!-- ç½‘æ ¼çº¿ -->
                <view class="grid-line" wx:for="{{5}}" wx:key="*this" style="bottom: {{item * 20}}%"></view>
              </view>
              <view class="chart-line">
                <!-- è¶‹åŠ¿ç‚¹ -->
                <view class="trend-point" 
                      wx:for="{{trendData}}" 
                      wx:key="index"
                      style="left: {{item.x}}%; bottom: {{item.y}}%"
                      data-score="{{item.score}}"
                      data-date="{{item.date}}">
                  <view class="point-dot {{item.isLatest ? 'latest' : ''}}"></view>
                  <view class="point-label">{{item.score}}</view>
                </view>
                <!-- è¿æ¥çº¿ -->
                <view class="trend-line" wx:if="{{trendData.length > 1}}">
                  <svg class="line-svg" viewBox="0 0 100 100" preserveAspectRatio="none">
                    <polyline points="{{trendLinePoints}}" 
                              fill="none" 
                              stroke="#4A90E2" 
                              stroke-width="2"
                              stroke-linecap="round"
                              stroke-linejoin="round"/>
                  </svg>
                </view>
              </view>
            </view>
            <view class="chart-labels">
              <text class="label-left">æœ€æ—©</text>
              <text class="label-right">æœ€æ–°</text>
            </view>
          </view>
          
          <!-- æœ€æ–°è¯„æµ‹ç»“æœ -->
          <view wx:if="{{latestAssessment}}" class="latest-result">
            <view class="result-header">
              <text class="result-title">æœ€æ–°è¯„æµ‹</text>
              <text class="result-date">{{latestAssessment.date}}</text>
            </view>
            <view class="result-content">
              <view class="result-score">
                <text class="score-number">{{latestAssessment.total_score || latestAssessment.result}}</text>
                <text class="score-unit">åˆ†</text>
              </view>
              <view class="result-info">
                <text class="result-name">{{latestAssessment.scale_name}}</text>
                <text class="result-status">{{latestAssessment.result}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- è¯„æµ‹è¯´æ˜ -->
      <view class="content-section">
        <view class="section-header">
          <view class="section-title">è¯„æµ‹è¯´æ˜</view>
        </view>

        <view class="card">
          <view class="info-content">
            <view class="info-item">ğŸ“‹ è¯·åœ¨å®‰é™çš„ç¯å¢ƒä¸­å®Œæˆè¯„æµ‹</view>
            <view class="info-item">ğŸ¯ æ ¹æ®æœ€è¿‘ä¸€å‘¨çš„æ„Ÿå—å¦‚å®ä½œç­”</view>
            <view class="info-item">âš ï¸ è¯„æµ‹ç»“æœä»…ä¾›å‚è€ƒï¼Œä¸ä½œä¸ºè¯Šæ–­ä¾æ®</view>
            <view class="info-item">ğŸµ å®Œæˆè¯„æµ‹åå¯ç”Ÿæˆä¸ªæ€§åŒ–ç–—æ„ˆéŸ³ä¹</view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- å…¨å±€åº•éƒ¨èœå•æ  -->
<global-tabbar 
  id="globalTabbar"
  current-page="assessment"
  theme-class="{{themeClass}}"
  visible="{{true}}"
/>
