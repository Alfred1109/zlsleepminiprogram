# 🔄 小程序端改造适配指南

## 📋 概述

由于后端音乐系统进行了统一整合和端口冗余清理，小程序端需要相应的改造以适配新的API接口。本文档详细说明了所需的改造内容和迁移步骤。

## 🎯 主要变更概述

| 变更类型 | 影响范围 | 紧急程度 |
|----------|----------|----------|
| **API端点变更** | 音乐生成相关功能 | 🔴 高 |
| **参数格式调整** | 请求参数标准化 | 🟡 中 |
| **响应格式更新** | 数据解析逻辑 | 🟡 中 |
| **下载流程变更** | 音乐下载功能 | 🟠 中高 |
| **页面跳转调整** | 详情页路由 | 🟢 低 |

## 🔄 API端点变更

### 1. **音乐生成API整合**

#### ❌ **废弃的API端点**
```javascript
// 这些接口已废弃，将返回410状态码
POST /api/music/generate              // 60秒音乐生成
POST /api/music/create_long_sequence  // 长序列音乐生成
POST /api/async-music/generate        // 异步60秒生成
POST /api/async-music/long-sequence/generate // 异步长序列生成
```

#### ✅ **新的统一API端点**
```javascript
POST /api/music/generate-unified      // 统一音乐生成接口
```

### 2. **具体改造示例**

#### 🔄 **60秒音乐生成改造**

```javascript
// ❌ 旧代码
wx.request({
  url: 'https://your-domain.com/api/music/generate',
  method: 'POST',
  data: {
    assessment_id: 123,
    scene_id: 1,
    music_style: 'healing'
  },
  success: (res) => {
    if (res.data.success) {
      // 处理成功响应
      const musicId = res.data.data.music_id;
      wx.navigateTo({
        url: `/pages/music/detail?id=${musicId}&type=short`
      });
    }
  }
});

// ✅ 新代码
wx.request({
  url: 'https://your-domain.com/api/music/generate-unified',
  method: 'POST',
  data: {
    assessment_id: 123,
    duration_seconds: 60,        // 新增：明确指定时长
    scene_id: 1,
    music_style: 'healing'
  },
  success: (res) => {
    if (res.data.success) {
      // 处理成功响应
      const musicId = res.data.data.music_id;
      wx.navigateTo({
        url: `/pages/music/detail?id=${musicId}`  // 统一详情页
      });
    }
  }
});
```

#### 🔄 **长序列音乐生成改造**

```javascript
// ❌ 旧代码
wx.request({
  url: 'https://your-domain.com/api/music/create_long_sequence',
  method: 'POST',
  data: {
    assessment_id: 123,
    duration_minutes: 30,        // 旧参数
    sequence_type: 'iso_three_stage'
  },
  success: (res) => {
    if (res.data.success) {
      const sessionId = res.data.data.session_id;
      wx.navigateTo({
        url: `/pages/music/long-detail?session_id=${sessionId}`
      });
    }
  }
});

// ✅ 新代码  
wx.request({
  url: 'https://your-domain.com/api/music/generate-unified',
  method: 'POST',
  data: {
    assessment_id: 123,
    duration_seconds: 1800,      // 新参数：30分钟 = 1800秒
    music_style: 'iso_three_stage'
  },
  success: (res) => {
    if (res.data.success) {
      const musicId = res.data.data.music_id;  // 统一返回music_id
      wx.navigateTo({
        url: `/pages/music/detail?id=${musicId}`  // 统一详情页
      });
    }
  }
});
```

## 📝 参数格式标准化

### 1. **请求参数变更**

| 功能 | 旧参数 | 新参数 | 说明 |
|------|--------|--------|------|
| **时长指定** | `duration_minutes: 30` | `duration_seconds: 1800` | 统一使用秒为单位 |
| **音乐风格** | `sequence_type: "iso_three_stage"` | `music_style: "iso_three_stage"` | 参数名统一 |
| **用户ID** | 从token解析 | 可选传递 `user_id` | 支持显式指定 |

### 2. **新增可选参数**

```javascript
// 新接口支持的完整参数
{
  assessment_id: 123,           // 必需：评测ID
  duration_seconds: 60,         // 必需：音乐时长（秒）
  music_style: 'healing',       // 可选：音乐风格
  scene_id: 1,                  // 可选：场景ID
  user_id: 456,                 // 可选：用户ID（通常从token获取）
  enhanced: false               // 可选：是否启用增强模式
}
```

## 📊 响应格式更新

### 1. **成功响应格式**

```javascript
// 统一的成功响应格式
{
  "success": true,
  "data": {
    "music_id": 123,              // 统一使用music_id
    "status": "completed",        // 状态：completed/generating/failed
    "duration_seconds": 60,       // 实际时长
    "file_path": "/path/to/file", // 文件路径（如果同步完成）
    "task_id": "async_task_123",  // 异步任务ID（如果异步处理）
    "estimated_time": 30,         // 预估完成时间（秒）
    "created_at": "2024-01-01T12:00:00Z"
  }
}
```

### 2. **错误响应处理**

```javascript
// 新增：废弃API的错误响应
{
  "success": false,
  "error": "此接口已废弃，请使用 /api/music/generate-unified",
  "deprecated": true,
  "new_endpoint": "/api/music/generate-unified",
  "migration_guide": "新接口支持任意时长音乐生成，参数基本兼容"
}

// 小程序端处理示例
wx.request({
  url: oldApiUrl,
  fail: (res) => {
    if (res.statusCode === 410 || res.data.deprecated) {
      // 检测到废弃API，提示用户升级
      wx.showModal({
        title: '功能升级',
        content: '音乐生成功能已升级，请更新小程序版本获得更好体验',
        confirmText: '立即更新',
        success: (res) => {
          if (res.confirm) {
            wx.navigateTo({
              url: '/pages/upgrade/index'
            });
          }
        }
      });
    }
  }
});
```

## 🎵 音乐下载流程变更

### 1. **下载接口升级**

#### ❌ **旧的下载方式**
```javascript
// 直接下载（已废弃）
const downloadUrl = `https://your-domain.com/api/music/download/${musicId}`;
wx.downloadFile({
  url: downloadUrl,
  success: (res) => {
    // 处理下载结果
  }
});
```

#### ✅ **新的安全下载方式**
```javascript
// Step 1: 获取安全下载链接
wx.request({
  url: `https://your-domain.com/api/downloads/url/${musicId}`,
  method: 'GET',
  header: {
    'Authorization': `Bearer ${token}`
  },
  success: (res) => {
    if (res.data.success) {
      const downloadInfo = res.data.data;
      
      // Step 2: 使用安全链接下载
      wx.downloadFile({
        url: downloadInfo.download_url,
        success: (downloadRes) => {
          // 处理下载结果
          wx.saveFile({
            tempFilePath: downloadRes.tempFilePath,
            success: (saveRes) => {
              wx.showToast({
                title: '下载完成',
                icon: 'success'
              });
            }
          });
        }
      });
    }
  }
});
```

### 2. **下载权限检查**

```javascript
// 新增：下载前权限检查
function checkDownloadPermission(musicId) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: `https://your-domain.com/api/downloads/check-permission/${musicId}`,
      header: {
        'Authorization': `Bearer ${token}`
      },
      success: (res) => {
        if (res.data.success && res.data.data.allowed) {
          resolve(res.data.data);
        } else {
          reject(res.data.data.reason || '无下载权限');
        }
      },
      fail: reject
    });
  });
}

// 使用示例
checkDownloadPermission(musicId)
  .then(() => {
    // 执行下载
    downloadMusic(musicId);
  })
  .catch((error) => {
    wx.showModal({
      title: '无法下载',
      content: error,
      showCancel: false
    });
  });
```

## 🔗 页面跳转调整

### 1. **统一详情页路由**

#### ❌ **旧的页面跳转**
```javascript
// 分别跳转不同页面
if (musicType === 'short') {
  wx.navigateTo({
    url: `/pages/music/short-detail?id=${musicId}`
  });
} else if (musicType === 'long') {
  wx.navigateTo({
    url: `/pages/music/long-detail?session_id=${sessionId}`
  });
}
```

#### ✅ **新的统一跳转**
```javascript
// 统一跳转到同一个详情页
wx.navigateTo({
  url: `/pages/music/detail?id=${musicId}`
});
```

### 2. **详情页面适配**

```javascript
// pages/music/detail.js
Page({
  data: {
    musicInfo: {},
    isLoading: true
  },
  
  onLoad(options) {
    const musicId = options.id;
    this.loadMusicDetail(musicId);
  },
  
  loadMusicDetail(musicId) {
    wx.request({
      url: `https://your-domain.com/api/music/detail/${musicId}`,
      success: (res) => {
        if (res.data.success) {
          const musicInfo = res.data.data;
          
          // 统一处理不同时长的音乐
          this.setData({
            musicInfo: {
              id: musicInfo.id,
              title: this.generateTitle(musicInfo),
              duration: this.formatDuration(musicInfo.duration_seconds),
              status: musicInfo.status,
              createdAt: musicInfo.created_at,
              playUrl: musicInfo.play_url,
              downloadUrl: musicInfo.download_url,
              // 根据时长判断类型
              type: musicInfo.duration_seconds <= 300 ? 'short' : 'long',
              typeDisplay: musicInfo.duration_seconds <= 300 ? '快速音乐' : '长序列音乐'
            },
            isLoading: false
          });
        }
      }
    });
  },
  
  generateTitle(musicInfo) {
    const duration = Math.round(musicInfo.duration_seconds / 60);
    return `${duration}分钟疗愈音乐`;
  },
  
  formatDuration(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return minutes > 0 ? `${minutes}分${remainingSeconds}秒` : `${seconds}秒`;
  }
});
```

## 🛠️ 工具函数更新

### 1. **API请求封装**

```javascript
// utils/api.js - 创建统一的API请求工具
class MusicAPI {
  static baseUrl = 'https://your-domain.com';
  
  // 统一音乐生成
  static generateMusic(params) {
    return new Promise((resolve, reject) => {
      wx.request({
        url: `${this.baseUrl}/api/music/generate-unified`,
        method: 'POST',
        data: params,
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('token')}`
        },
        success: (res) => {
          if (res.data.success) {
            resolve(res.data.data);
          } else {
            reject(new Error(res.data.error || '请求失败'));
          }
        },
        fail: (err) => {
          // 处理废弃API的特殊情况
          if (err.statusCode === 410) {
            reject(new Error('功能已升级，请更新小程序版本'));
          } else {
            reject(new Error('网络请求失败'));
          }
        }
      });
    });
  }
  
  // 快速生成（1分钟）
  static generateQuickMusic(assessmentId, sceneId = 0) {
    return this.generateMusic({
      assessment_id: assessmentId,
      duration_seconds: 60,
      scene_id: sceneId,
      music_style: 'healing'
    });
  }
  
  // 中等时长生成（5分钟）
  static generateMediumMusic(assessmentId, sceneId = 0) {
    return this.generateMusic({
      assessment_id: assessmentId,
      duration_seconds: 300,
      scene_id: sceneId,
      music_style: 'healing'
    });
  }
  
  // 长序列生成（30分钟）
  static generateLongMusic(assessmentId, sceneId = 0) {
    return this.generateMusic({
      assessment_id: assessmentId,
      duration_seconds: 1800,
      scene_id: sceneId,
      music_style: 'iso_three_stage'
    });
  }
  
  // 获取安全下载链接
  static getDownloadUrl(musicId, quality = 'standard') {
    return new Promise((resolve, reject) => {
      wx.request({
        url: `${this.baseUrl}/api/downloads/url/${musicId}`,
        method: 'GET',
        data: { quality },
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('token')}`
        },
        success: (res) => {
          if (res.data.success) {
            resolve(res.data.data);
          } else {
            reject(new Error(res.data.error || '获取下载链接失败'));
          }
        },
        fail: reject
      });
    });
  }
}

module.exports = MusicAPI;
```

### 2. **使用示例**

```javascript
// pages/assessment/result.js
const MusicAPI = require('../../utils/api.js');

Page({
  data: {
    assessmentId: null,
    isGenerating: false
  },
  
  // 生成快速音乐
  async generateQuick() {
    try {
      this.setData({ isGenerating: true });
      
      const result = await MusicAPI.generateQuickMusic(this.data.assessmentId);
      
      wx.showToast({
        title: '生成成功',
        icon: 'success'
      });
      
      // 跳转到统一详情页
      wx.navigateTo({
        url: `/pages/music/detail?id=${result.music_id}`
      });
      
    } catch (error) {
      wx.showModal({
        title: '生成失败',
        content: error.message,
        showCancel: false
      });
    } finally {
      this.setData({ isGenerating: false });
    }
  },
  
  // 生成长序列音乐
  async generateLong() {
    try {
      this.setData({ isGenerating: true });
      
      const result = await MusicAPI.generateLongMusic(this.data.assessmentId);
      
      if (result.status === 'generating') {
        // 异步生成，显示进度页面
        wx.navigateTo({
          url: `/pages/music/progress?task_id=${result.task_id}&music_id=${result.music_id}`
        });
      } else {
        // 同步完成，直接跳转详情
        wx.navigateTo({
          url: `/pages/music/detail?id=${result.music_id}`
        });
      }
      
    } catch (error) {
      wx.showModal({
        title: '生成失败', 
        content: error.message,
        showCancel: false
      });
    } finally {
      this.setData({ isGenerating: false });
    }
  }
});
```

## 🧪 测试建议

### 1. **API兼容性测试**

```javascript
// test/api-compatibility.js
const testCases = [
  {
    name: '快速音乐生成',
    api: '/api/music/generate-unified',
    data: {
      assessment_id: 1,
      duration_seconds: 60
    },
    expect: {
      success: true,
      data: {
        music_id: 'number',
        status: 'string'
      }
    }
  },
  {
    name: '长序列音乐生成',
    api: '/api/music/generate-unified', 
    data: {
      assessment_id: 1,
      duration_seconds: 1800
    },
    expect: {
      success: true,
      data: {
        music_id: 'number',
        status: 'string'
      }
    }
  }
];

// 执行测试
testCases.forEach(async (testCase) => {
  try {
    const result = await wx.request({
      url: baseUrl + testCase.api,
      method: 'POST',
      data: testCase.data
    });
    
    console.log(`✅ ${testCase.name}: 通过`);
  } catch (error) {
    console.error(`❌ ${testCase.name}: 失败`, error);
  }
});
```

### 2. **错误处理测试**

```javascript
// 测试废弃API的响应
wx.request({
  url: 'https://your-domain.com/api/music/generate', // 已废弃
  method: 'POST',
  data: { assessment_id: 1 },
  complete: (res) => {
    if (res.statusCode === 410) {
      console.log('✅ 废弃API正确返回410状态码');
      if (res.data.deprecated === true) {
        console.log('✅ 废弃标记正确');
      }
      if (res.data.new_endpoint) {
        console.log('✅ 新端点指引正确:', res.data.new_endpoint);
      }
    }
  }
});
```

## 📅 迁移时间表

### 🚀 **阶段1：准备阶段（1-2周）**
- [ ] 熟悉新API接口文档
- [ ] 准备测试环境和测试数据
- [ ] 创建API工具类和公共函数
- [ ] 设计错误处理和降级策略

### 🔄 **阶段2：核心功能迁移（2-3周）**
- [ ] 迁移音乐生成相关页面
- [ ] 更新详情页面为统一版本
- [ ] 实现新的下载流程
- [ ] 更新页面跳转逻辑

### 🧪 **阶段3：测试验证（1周）**
- [ ] 功能测试：确保所有音乐生成场景正常
- [ ] 兼容性测试：验证新旧接口切换
- [ ] 性能测试：对比新旧接口性能
- [ ] 用户体验测试：确保交互流畅

### 🚀 **阶段4：发布上线（1周）**
- [ ] 准备发布版本
- [ ] 监控新接口调用情况
- [ ] 收集用户反馈
- [ ] 修复发现的问题

## ⚠️ 注意事项

### 1. **向后兼容性**
- 后端在6个月内保持废弃API的410响应
- 小程序需要在此期间完成迁移
- 建议尽快迁移以获得最佳性能

### 2. **错误处理**
```javascript
// 推荐的错误处理策略
function handleApiError(error, apiName) {
  if (error.statusCode === 410) {
    // 废弃API处理
    wx.showModal({
      title: '功能升级',
      content: '请更新小程序到最新版本',
      confirmText: '立即更新',
      success: (res) => {
        if (res.confirm) {
          // 引导用户更新
          wx.navigateToMiniProgram({
            appId: 'your-app-id' // 如果需要
          });
        }
      }
    });
  } else {
    // 常规错误处理
    wx.showToast({
      title: error.message || '请求失败',
      icon: 'none'
    });
  }
}
```

### 3. **性能优化建议**
- 使用统一的API请求工具类，避免重复代码
- 实现请求缓存，减少不必要的网络请求
- 对于长音乐生成，实现轮询状态检查
- 优化页面加载，使用占位符提升用户体验

## 📞 技术支持

如在迁移过程中遇到问题，请联系：
- **API文档**：查看最新的接口文档
- **技术群**：加入开发者技术交流群
- **Issue反馈**：通过GitHub或其他渠道反馈问题

---

🎵 **通过这次改造，小程序将获得更统一、更高效的音乐生成体验！** ✨
