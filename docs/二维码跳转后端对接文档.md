# 小程序二维码跳转后端对接文档

## 📋 概述

本文档说明如何在后端生成二维码并配合小程序处理二维码跳转到商品详情页的功能。

## 🔧 技术原理

微信小程序通过二维码进入时，会在 `onLaunch` 和 `onShow` 方法中携带 `scene` 参数。小程序前端会解析这个 `scene` 值，并根据规则跳转到对应的商品详情页。

## 📝 二维码生成规范

### 方案一：直接使用商品ID作为场景值（推荐）

```javascript
// 生成二维码时，直接将商品ID作为scene参数
const scene = productId.toString(); // 例如: "123"

// 使用微信API生成小程序码
const response = await axios.post('https://api.weixin.qq.com/wxa/getwxacodeunlimit', {
  scene: scene,
  page: 'pages/index/index', // 可以是任意有效页面，小程序会自动跳转
  width: 430,
  auto_color: false,
  line_color: { "r": 0, "g": 0, "b": 0 },
  is_hyaline: false
}, {
  headers: {
    'Content-Type': 'application/json'
  },
  responseType: 'arraybuffer'
});
```

### 方案二：使用编码后的场景值

```javascript
// 如果需要传递更多信息，可以使用编码
const sceneData = {
  type: 'product',
  id: productId,
  source: 'qrcode',
  timestamp: Date.now()
};

// 方法1: Base64编码（注意长度限制32字符）
const scene = Buffer.from(JSON.stringify(sceneData)).toString('base64').substring(0, 32);

// 方法2: 自定义编码格式
const scene = `QR${Date.now().toString(36)}${productId}`;

// 生成二维码
const response = await axios.post('https://api.weixin.qq.com/wxa/getwxacodeunlimit', {
  scene: scene,
  page: 'pages/index/index',
  width: 430
}, {
  headers: {
    'Content-Type': 'application/json'
  },
  responseType: 'arraybuffer'
});
```

## 🔌 需要实现的API接口

当使用方案二（编码场景值）时，需要实现以下接口供小程序调用：

### 接口规范

```http
POST /api/qr/resolve
Content-Type: application/json

{
  "scene": "QR20250926145233C4CA423866FE2B75"
}
```

### 响应格式

```json
{
  "success": true,
  "data": {
    "type": "product",
    "productId": "123",
    "metadata": {
      "source": "qrcode",
      "timestamp": 1632739200000
    }
  }
}
```

### 错误响应

```json
{
  "success": false,
  "error": "Invalid scene code",
  "code": "INVALID_SCENE"
}
```

## 💻 后端实现示例

### Node.js + Express 示例

```javascript
const express = require('express');
const app = express();

// 二维码场景值解析接口
app.post('/api/qr/resolve', async (req, res) => {
  try {
    const { scene } = req.body;
    
    if (!scene) {
      return res.json({
        success: false,
        error: 'Scene parameter is required',
        code: 'MISSING_SCENE'
      });
    }
    
    // 解析场景值
    const result = await resolveScene(scene);
    
    if (!result) {
      return res.json({
        success: false,
        error: 'Invalid scene code',
        code: 'INVALID_SCENE'
      });
    }
    
    res.json({
      success: true,
      data: result
    });
    
  } catch (error) {
    console.error('场景值解析失败:', error);
    res.json({
      success: false,
      error: 'Internal server error',
      code: 'SERVER_ERROR'
    });
  }
});

// 场景值解析逻辑
async function resolveScene(scene) {
  // 方法1: 数据库查找
  const qrRecord = await QRCode.findOne({ scene: scene });
  if (qrRecord) {
    return {
      type: qrRecord.type,
      productId: qrRecord.productId,
      metadata: qrRecord.metadata
    };
  }
  
  // 方法2: 解析编码格式
  if (scene.startsWith('QR')) {
    // 自定义解析逻辑
    const matches = scene.match(/QR\w+(\d+)$/);
    if (matches && matches[1]) {
      return {
        type: 'product',
        productId: matches[1]
      };
    }
  }
  
  // 方法3: Base64解码
  try {
    const decoded = Buffer.from(scene, 'base64').toString('utf8');
    const data = JSON.parse(decoded);
    if (data.type && data.id) {
      return {
        type: data.type,
        productId: data.id,
        metadata: data
      };
    }
  } catch (e) {
    // 解码失败，继续其他方法
  }
  
  return null;
}
```

### PHP Laravel 示例

```php
<?php
// routes/api.php
Route::post('/qr/resolve', [QRCodeController::class, 'resolve']);

// app/Http/Controllers/QRCodeController.php
class QRCodeController extends Controller
{
    public function resolve(Request $request)
    {
        $scene = $request->input('scene');
        
        if (empty($scene)) {
            return response()->json([
                'success' => false,
                'error' => 'Scene parameter is required',
                'code' => 'MISSING_SCENE'
            ]);
        }
        
        $result = $this->resolveScene($scene);
        
        if (!$result) {
            return response()->json([
                'success' => false,
                'error' => 'Invalid scene code',
                'code' => 'INVALID_SCENE'
            ]);
        }
        
        return response()->json([
            'success' => true,
            'data' => $result
        ]);
    }
    
    private function resolveScene($scene)
    {
        // 数据库查找
        $qrRecord = QRCode::where('scene', $scene)->first();
        if ($qrRecord) {
            return [
                'type' => $qrRecord->type,
                'productId' => $qrRecord->product_id,
                'metadata' => json_decode($qrRecord->metadata, true)
            ];
        }
        
        // 自定义格式解析
        if (str_starts_with($scene, 'QR')) {
            preg_match('/QR\w+(\d+)$/', $scene, $matches);
            if (isset($matches[1])) {
                return [
                    'type' => 'product',
                    'productId' => $matches[1]
                ];
            }
        }
        
        return null;
    }
}
```

## 🗄️ 数据库设计建议

为了更好地管理二维码，建议创建专门的数据表：

```sql
CREATE TABLE qr_codes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    scene VARCHAR(32) UNIQUE NOT NULL COMMENT '场景值',
    type ENUM('product', 'scene', 'activity') NOT NULL COMMENT '类型',
    target_id BIGINT NOT NULL COMMENT '目标ID（商品ID等）',
    metadata JSON COMMENT '附加数据',
    expires_at TIMESTAMP NULL COMMENT '过期时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_scene (scene),
    INDEX idx_type_target (type, target_id)
);
```

## 🧪 测试方法

### 1. 接口测试

```bash
# 测试场景值解析接口
curl -X POST https://your-api.com/api/qr/resolve \
  -H "Content-Type: application/json" \
  -d '{"scene": "123"}'

# 预期响应
{
  "success": true,
  "data": {
    "type": "product",
    "productId": "123"
  }
}
```

### 2. 小程序测试

在微信开发者工具中：

1. **编译模式设置**：
   - 添加编译模式
   - 启动参数：`scene=123`
   - 启动页面：`pages/index/index`

2. **模拟器测试**：
   - 选择编译模式启动
   - 观察控制台日志
   - 验证是否正确跳转到商品详情页

3. **真机测试**：
   - 生成测试二维码
   - 用微信扫描
   - 验证跳转效果

## ⚠️ 注意事项

### 场景值限制

- **长度限制**：最大32个字符
- **字符限制**：支持数字、字母、下划线
- **唯一性**：同一个小程序内场景值需要唯一

### 错误处理

1. **场景值无效**：跳转到首页
2. **商品不存在**：显示错误提示
3. **网络错误**：显示重试选项

### 性能优化

1. **缓存机制**：对解析结果进行缓存
2. **异步处理**：避免阻塞用户体验
3. **降级方案**：解析失败时的备用处理

## 📊 统计分析

建议记录以下数据用于分析：

```javascript
// 二维码扫描统计
{
  scene: 'QR123456',
  userOpenId: 'xxx',
  scanTime: '2024-01-01 12:00:00',
  userAgent: 'WeChat/xxx',
  success: true,
  targetType: 'product',
  targetId: '123'
}
```

## 🔗 相关链接

- [微信小程序获取二维码API文档](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/qr-code/wxacode.getUnlimited.html)
- [小程序场景值官方文档](https://developers.weixin.qq.com/miniprogram/dev/reference/scene.html)

---

📞 **技术支持**：如有疑问请联系前端开发团队
📅 **更新时间**：2024年1月
