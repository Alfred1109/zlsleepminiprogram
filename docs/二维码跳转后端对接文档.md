# å°ç¨‹åºäºŒç»´ç è·³è½¬åç«¯å¯¹æ¥æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•åœ¨åç«¯ç”ŸæˆäºŒç»´ç å¹¶é…åˆå°ç¨‹åºå¤„ç†äºŒç»´ç è·³è½¬åˆ°å•†å“è¯¦æƒ…é¡µçš„åŠŸèƒ½ã€‚

## ğŸ”§ æŠ€æœ¯åŸç†

å¾®ä¿¡å°ç¨‹åºé€šè¿‡äºŒç»´ç è¿›å…¥æ—¶ï¼Œä¼šåœ¨ `onLaunch` å’Œ `onShow` æ–¹æ³•ä¸­æºå¸¦ `scene` å‚æ•°ã€‚å°ç¨‹åºå‰ç«¯ä¼šè§£æè¿™ä¸ª `scene` å€¼ï¼Œå¹¶æ ¹æ®è§„åˆ™è·³è½¬åˆ°å¯¹åº”çš„å•†å“è¯¦æƒ…é¡µã€‚

## ğŸ“ äºŒç»´ç ç”Ÿæˆè§„èŒƒ

### æ–¹æ¡ˆä¸€ï¼šç›´æ¥ä½¿ç”¨å•†å“IDä½œä¸ºåœºæ™¯å€¼ï¼ˆæ¨èï¼‰

```javascript
// ç”ŸæˆäºŒç»´ç æ—¶ï¼Œç›´æ¥å°†å•†å“IDä½œä¸ºsceneå‚æ•°
const scene = productId.toString(); // ä¾‹å¦‚: "123"

// ä½¿ç”¨å¾®ä¿¡APIç”Ÿæˆå°ç¨‹åºç 
const response = await axios.post('https://api.weixin.qq.com/wxa/getwxacodeunlimit', {
  scene: scene,
  page: 'pages/index/index', // å¯ä»¥æ˜¯ä»»æ„æœ‰æ•ˆé¡µé¢ï¼Œå°ç¨‹åºä¼šè‡ªåŠ¨è·³è½¬
  width: 430,
  auto_color: false,
  line_color: { "r": 0, "g": 0, "b": 0 },
  is_hyaline: false
}, {
  headers: {
    'Content-Type': 'application/json'
  },
  responseType: 'arraybuffer'
});
```

### æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ç¼–ç åçš„åœºæ™¯å€¼

```javascript
// å¦‚æœéœ€è¦ä¼ é€’æ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨ç¼–ç 
const sceneData = {
  type: 'product',
  id: productId,
  source: 'qrcode',
  timestamp: Date.now()
};

// æ–¹æ³•1: Base64ç¼–ç ï¼ˆæ³¨æ„é•¿åº¦é™åˆ¶32å­—ç¬¦ï¼‰
const scene = Buffer.from(JSON.stringify(sceneData)).toString('base64').substring(0, 32);

// æ–¹æ³•2: è‡ªå®šä¹‰ç¼–ç æ ¼å¼
const scene = `QR${Date.now().toString(36)}${productId}`;

// ç”ŸæˆäºŒç»´ç 
const response = await axios.post('https://api.weixin.qq.com/wxa/getwxacodeunlimit', {
  scene: scene,
  page: 'pages/index/index',
  width: 430
}, {
  headers: {
    'Content-Type': 'application/json'
  },
  responseType: 'arraybuffer'
});
```

## ğŸ”Œ éœ€è¦å®ç°çš„APIæ¥å£

å½“ä½¿ç”¨æ–¹æ¡ˆäºŒï¼ˆç¼–ç åœºæ™¯å€¼ï¼‰æ—¶ï¼Œéœ€è¦å®ç°ä»¥ä¸‹æ¥å£ä¾›å°ç¨‹åºè°ƒç”¨ï¼š

### æ¥å£è§„èŒƒ

```http
POST /api/qr/resolve
Content-Type: application/json

{
  "scene": "QR20250926145233C4CA423866FE2B75"
}
```

### å“åº”æ ¼å¼

```json
{
  "success": true,
  "data": {
    "type": "product",
    "productId": "123",
    "metadata": {
      "source": "qrcode",
      "timestamp": 1632739200000
    }
  }
}
```

### é”™è¯¯å“åº”

```json
{
  "success": false,
  "error": "Invalid scene code",
  "code": "INVALID_SCENE"
}
```

## ğŸ’» åç«¯å®ç°ç¤ºä¾‹

### Node.js + Express ç¤ºä¾‹

```javascript
const express = require('express');
const app = express();

// äºŒç»´ç åœºæ™¯å€¼è§£ææ¥å£
app.post('/api/qr/resolve', async (req, res) => {
  try {
    const { scene } = req.body;
    
    if (!scene) {
      return res.json({
        success: false,
        error: 'Scene parameter is required',
        code: 'MISSING_SCENE'
      });
    }
    
    // è§£æåœºæ™¯å€¼
    const result = await resolveScene(scene);
    
    if (!result) {
      return res.json({
        success: false,
        error: 'Invalid scene code',
        code: 'INVALID_SCENE'
      });
    }
    
    res.json({
      success: true,
      data: result
    });
    
  } catch (error) {
    console.error('åœºæ™¯å€¼è§£æå¤±è´¥:', error);
    res.json({
      success: false,
      error: 'Internal server error',
      code: 'SERVER_ERROR'
    });
  }
});

// åœºæ™¯å€¼è§£æé€»è¾‘
async function resolveScene(scene) {
  // æ–¹æ³•1: æ•°æ®åº“æŸ¥æ‰¾
  const qrRecord = await QRCode.findOne({ scene: scene });
  if (qrRecord) {
    return {
      type: qrRecord.type,
      productId: qrRecord.productId,
      metadata: qrRecord.metadata
    };
  }
  
  // æ–¹æ³•2: è§£æç¼–ç æ ¼å¼
  if (scene.startsWith('QR')) {
    // è‡ªå®šä¹‰è§£æé€»è¾‘
    const matches = scene.match(/QR\w+(\d+)$/);
    if (matches && matches[1]) {
      return {
        type: 'product',
        productId: matches[1]
      };
    }
  }
  
  // æ–¹æ³•3: Base64è§£ç 
  try {
    const decoded = Buffer.from(scene, 'base64').toString('utf8');
    const data = JSON.parse(decoded);
    if (data.type && data.id) {
      return {
        type: data.type,
        productId: data.id,
        metadata: data
      };
    }
  } catch (e) {
    // è§£ç å¤±è´¥ï¼Œç»§ç»­å…¶ä»–æ–¹æ³•
  }
  
  return null;
}
```

### PHP Laravel ç¤ºä¾‹

```php
<?php
// routes/api.php
Route::post('/qr/resolve', [QRCodeController::class, 'resolve']);

// app/Http/Controllers/QRCodeController.php
class QRCodeController extends Controller
{
    public function resolve(Request $request)
    {
        $scene = $request->input('scene');
        
        if (empty($scene)) {
            return response()->json([
                'success' => false,
                'error' => 'Scene parameter is required',
                'code' => 'MISSING_SCENE'
            ]);
        }
        
        $result = $this->resolveScene($scene);
        
        if (!$result) {
            return response()->json([
                'success' => false,
                'error' => 'Invalid scene code',
                'code' => 'INVALID_SCENE'
            ]);
        }
        
        return response()->json([
            'success' => true,
            'data' => $result
        ]);
    }
    
    private function resolveScene($scene)
    {
        // æ•°æ®åº“æŸ¥æ‰¾
        $qrRecord = QRCode::where('scene', $scene)->first();
        if ($qrRecord) {
            return [
                'type' => $qrRecord->type,
                'productId' => $qrRecord->product_id,
                'metadata' => json_decode($qrRecord->metadata, true)
            ];
        }
        
        // è‡ªå®šä¹‰æ ¼å¼è§£æ
        if (str_starts_with($scene, 'QR')) {
            preg_match('/QR\w+(\d+)$/', $scene, $matches);
            if (isset($matches[1])) {
                return [
                    'type' => 'product',
                    'productId' => $matches[1]
                ];
            }
        }
        
        return null;
    }
}
```

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡å»ºè®®

ä¸ºäº†æ›´å¥½åœ°ç®¡ç†äºŒç»´ç ï¼Œå»ºè®®åˆ›å»ºä¸“é—¨çš„æ•°æ®è¡¨ï¼š

```sql
CREATE TABLE qr_codes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    scene VARCHAR(32) UNIQUE NOT NULL COMMENT 'åœºæ™¯å€¼',
    type ENUM('product', 'scene', 'activity') NOT NULL COMMENT 'ç±»å‹',
    target_id BIGINT NOT NULL COMMENT 'ç›®æ ‡IDï¼ˆå•†å“IDç­‰ï¼‰',
    metadata JSON COMMENT 'é™„åŠ æ•°æ®',
    expires_at TIMESTAMP NULL COMMENT 'è¿‡æœŸæ—¶é—´',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_scene (scene),
    INDEX idx_type_target (type, target_id)
);
```

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### 1. æ¥å£æµ‹è¯•

```bash
# æµ‹è¯•åœºæ™¯å€¼è§£ææ¥å£
curl -X POST https://your-api.com/api/qr/resolve \
  -H "Content-Type: application/json" \
  -d '{"scene": "123"}'

# é¢„æœŸå“åº”
{
  "success": true,
  "data": {
    "type": "product",
    "productId": "123"
  }
}
```

### 2. å°ç¨‹åºæµ‹è¯•

åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ï¼š

1. **ç¼–è¯‘æ¨¡å¼è®¾ç½®**ï¼š
   - æ·»åŠ ç¼–è¯‘æ¨¡å¼
   - å¯åŠ¨å‚æ•°ï¼š`scene=123`
   - å¯åŠ¨é¡µé¢ï¼š`pages/index/index`

2. **æ¨¡æ‹Ÿå™¨æµ‹è¯•**ï¼š
   - é€‰æ‹©ç¼–è¯‘æ¨¡å¼å¯åŠ¨
   - è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—
   - éªŒè¯æ˜¯å¦æ­£ç¡®è·³è½¬åˆ°å•†å“è¯¦æƒ…é¡µ

3. **çœŸæœºæµ‹è¯•**ï¼š
   - ç”Ÿæˆæµ‹è¯•äºŒç»´ç 
   - ç”¨å¾®ä¿¡æ‰«æ
   - éªŒè¯è·³è½¬æ•ˆæœ

## âš ï¸ æ³¨æ„äº‹é¡¹

### åœºæ™¯å€¼é™åˆ¶

- **é•¿åº¦é™åˆ¶**ï¼šæœ€å¤§32ä¸ªå­—ç¬¦
- **å­—ç¬¦é™åˆ¶**ï¼šæ”¯æŒæ•°å­—ã€å­—æ¯ã€ä¸‹åˆ’çº¿
- **å”¯ä¸€æ€§**ï¼šåŒä¸€ä¸ªå°ç¨‹åºå†…åœºæ™¯å€¼éœ€è¦å”¯ä¸€

### é”™è¯¯å¤„ç†

1. **åœºæ™¯å€¼æ— æ•ˆ**ï¼šè·³è½¬åˆ°é¦–é¡µ
2. **å•†å“ä¸å­˜åœ¨**ï¼šæ˜¾ç¤ºé”™è¯¯æç¤º
3. **ç½‘ç»œé”™è¯¯**ï¼šæ˜¾ç¤ºé‡è¯•é€‰é¡¹

### æ€§èƒ½ä¼˜åŒ–

1. **ç¼“å­˜æœºåˆ¶**ï¼šå¯¹è§£æç»“æœè¿›è¡Œç¼“å­˜
2. **å¼‚æ­¥å¤„ç†**ï¼šé¿å…é˜»å¡ç”¨æˆ·ä½“éªŒ
3. **é™çº§æ–¹æ¡ˆ**ï¼šè§£æå¤±è´¥æ—¶çš„å¤‡ç”¨å¤„ç†

## ğŸ“Š ç»Ÿè®¡åˆ†æ

å»ºè®®è®°å½•ä»¥ä¸‹æ•°æ®ç”¨äºåˆ†æï¼š

```javascript
// äºŒç»´ç æ‰«æç»Ÿè®¡
{
  scene: 'QR123456',
  userOpenId: 'xxx',
  scanTime: '2024-01-01 12:00:00',
  userAgent: 'WeChat/xxx',
  success: true,
  targetType: 'product',
  targetId: '123'
}
```

## ğŸ”— ç›¸å…³é“¾æ¥

- [å¾®ä¿¡å°ç¨‹åºè·å–äºŒç»´ç APIæ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/qr-code/wxacode.getUnlimited.html)
- [å°ç¨‹åºåœºæ™¯å€¼å®˜æ–¹æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/reference/scene.html)

---

ğŸ“ **æŠ€æœ¯æ”¯æŒ**ï¼šå¦‚æœ‰ç–‘é—®è¯·è”ç³»å‰ç«¯å¼€å‘å›¢é˜Ÿ
ğŸ“… **æ›´æ–°æ—¶é—´**ï¼š2024å¹´1æœˆ
