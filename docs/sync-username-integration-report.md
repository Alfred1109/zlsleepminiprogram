# ç”¨æˆ·ååŒæ­¥åŠŸèƒ½é›†æˆæŠ¥å‘Š

> é›†æˆæ—¥æœŸï¼š2025-09-25  
> ç‰ˆæœ¬ï¼šv1.0  
> çŠ¶æ€ï¼šâœ… é›†æˆå®Œæˆ

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æˆåŠŸé›†æˆäº†æ‚¨æä¾›çš„ `sync_username` åŠŸèƒ½ï¼Œç°åœ¨ç”¨æˆ·æ›´æ–°æ˜µç§°æ—¶å¯ä»¥è‡ªåŠ¨åŒæ­¥ç”¨æˆ·åï¼Œå¹¶æ”¯æŒè­¦å‘Šä¿¡æ¯å¤„ç†ã€‚

## ğŸ”§ ä¿®æ”¹å†…å®¹

### 1. æ›´æ–° UserAPI.updateUserInfo æ–¹æ³•
**æ–‡ä»¶**: `utils/healingApi.js`

âœ… **æ–°å¢åŠŸèƒ½**:
- æ”¯æŒ `sync_username` å‚æ•°
- å¢å¼ºçš„æ—¥å¿—è®°å½•
- è­¦å‘Šä¿¡æ¯å¤„ç†
- å®Œæ•´çš„JSDocæ–‡æ¡£

```javascript
async updateUserInfo(data) {
  // æ”¯æŒçš„å‚æ•°ï¼š
  // - user_id: ç”¨æˆ·ID
  // - nickname: ç”¨æˆ·æ˜µç§°
  // - sync_username: æ˜¯å¦å¯ç”¨è‡ªåŠ¨åŒæ­¥ç”¨æˆ·å
  // - avatar_url: ç”¨æˆ·å¤´åƒURL
}
```

### 2. æ›´æ–° Profile é¡µé¢
**æ–‡ä»¶**: `pages/profile/profile.js`

âœ… **æ–°å¢åŠŸèƒ½**:
- `onNicknameChange` æ–¹æ³•ç°åœ¨æ”¯æŒ `sync_username: true`
- `onSaveProfile` æ–¹æ³•è‡ªåŠ¨æ£€æµ‹æ˜µç§°æ›´æ”¹å¹¶å¯ç”¨åŒæ­¥
- æ–°å¢ `showWarningMessage` æ–¹æ³•å¤„ç†è­¦å‘Šä¿¡æ¯
- æ”¹è¿›çš„ç”¨æˆ·åé¦ˆå’Œé”™è¯¯å¤„ç†

### 3. æ–°å¢ç¤ºä¾‹æ–‡ä»¶
**æ–‡ä»¶**: `utils/userUpdateExample.js`

âœ… **æä¾›**:
- é€šç”¨çš„ `updateUserInfoWithSync` æ–¹æ³•
- æŒ‰ç…§æ‚¨æä¾›æ ¼å¼çš„ `updateUserInfoDirectly` æ–¹æ³•
- å®Œæ•´çš„ä½¿ç”¨ç¤ºä¾‹
- è¯¦ç»†çš„å‚æ•°è¯´æ˜

### 4. æ–°å¢æµ‹è¯•æ–‡ä»¶
**æ–‡ä»¶**: `utils/userUpdateTest.js`

âœ… **åŒ…å«**:
- é›†æˆæµ‹è¯•ç”¨ä¾‹
- éªŒè¯æ–¹æ³•
- APIæ ¼å¼å…¼å®¹æ€§æ£€æŸ¥

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹å¼1ï¼šä½¿ç”¨é¡¹ç›®ç°æœ‰APIï¼ˆæ¨èï¼‰

```javascript
const { UserAPI } = require('../../utils/healingApi')

// æ›´æ–°æ˜µç§°å¹¶åŒæ­¥ç”¨æˆ·å
const result = await UserAPI.updateUserInfo({
  user_id: userInfo.id,
  nickname: 'ç”¨æˆ·æ–°æ˜µç§°',
  sync_username: true  // å¯ç”¨è‡ªåŠ¨åŒæ­¥
})

// å¤„ç†ç»“æœ
if (result.success) {
  console.log('æ›´æ–°æˆåŠŸ')
  if (result.warnings) {
    console.warn('è­¦å‘Šï¼š', result.warnings)
  }
}
```

### æ–¹å¼2ï¼šæŒ‰ç…§æ‚¨æä¾›çš„æ ¼å¼ä½¿ç”¨

```javascript
wx.request({
  url: 'https://yourdomain.com/api/auth/user/update',
  method: 'PUT',
  header: {
    'Authorization': 'Bearer ' + token,
    'Content-Type': 'application/json'
  },
  data: {
    user_id: userInfo.id,
    nickname: 'ç”¨æˆ·æ–°æ˜µç§°',
    sync_username: true  // å¯ç”¨è‡ªåŠ¨åŒæ­¥
  },
  success: function(res) {
    if (res.data.success) {
      console.log('æ˜µç§°æ›´æ–°æˆåŠŸï¼Œç”¨æˆ·åå·²åŒæ­¥')
      // å¦‚æœæœ‰è­¦å‘Šä¿¡æ¯ï¼ˆå¦‚ç”¨æˆ·åå†²çªï¼‰
      if (res.data.warnings) {
        console.warn('è­¦å‘Šï¼š', res.data.warnings)
        // æ˜¾ç¤ºè­¦å‘Šç»™ç”¨æˆ·
      }
    }
  }
})
```

### æ–¹å¼3ï¼šä½¿ç”¨å°è£…çš„æ–¹æ³•

```javascript
const { updateUserInfoWithSync } = require('../../utils/userUpdateExample')

// ç®€å•è°ƒç”¨
const result = await updateUserInfoWithSync({
  nickname: 'æ–°æ˜µç§°',
  syncUsername: true
})
```

## âš ï¸ è­¦å‘Šä¿¡æ¯å¤„ç†

ç³»ç»Ÿç°åœ¨æ”¯æŒå¤„ç†æœåŠ¡å™¨è¿”å›çš„è­¦å‘Šä¿¡æ¯ï¼š

- **ç”¨æˆ·åå†²çª**: å½“åŒæ­¥çš„ç”¨æˆ·åå·²å­˜åœ¨æ—¶ï¼ŒæœåŠ¡å™¨ä¼šè‡ªåŠ¨æ·»åŠ åç¼€å¹¶è¿”å›è­¦å‘Š
- **æ ¼å¼å»ºè®®**: å¯¹å¤´åƒæ ¼å¼ç­‰æä¾›ä¼˜åŒ–å»ºè®®
- **å…¶ä»–æç¤º**: ä»»ä½•éœ€è¦ç”¨æˆ·æ³¨æ„çš„ä¿¡æ¯

è­¦å‘Šä¿¡æ¯ä¼šé€šè¿‡ä»¥ä¸‹æ–¹å¼æ˜¾ç¤ºï¼š
- æ§åˆ¶å°æ—¥å¿—è®°å½•
- å¾®ä¿¡å°ç¨‹åºæ¨¡æ€æ¡†æç¤º
- Toastæ¶ˆæ¯ï¼ˆå¦‚æœåªæ˜¯è½»å¾®è­¦å‘Šï¼‰

## ğŸ” éªŒè¯æ–¹æ³•

1. **åœ¨Profileé¡µé¢**ï¼š
   - ä¿®æ”¹æ˜µç§°è¾“å…¥æ¡†çš„å†…å®¹
   - å¤±ç„¦æ—¶è‡ªåŠ¨ä¿å­˜å¹¶åŒæ­¥ç”¨æˆ·å
   - è§‚å¯Ÿæ˜¯å¦æ˜¾ç¤º"æ˜µç§°å·²ä¿å­˜ï¼Œç”¨æˆ·åå·²åŒæ­¥"æ¶ˆæ¯

2. **åœ¨å¼€å‘è€…å·¥å…·**ï¼š
   - æŸ¥çœ‹ç½‘ç»œè¯·æ±‚æ˜¯å¦åŒ…å« `sync_username: true`
   - æ£€æŸ¥å“åº”æ˜¯å¦åŒ…å« `warnings` å­—æ®µ
   - éªŒè¯ç”¨æˆ·ä¿¡æ¯æ˜¯å¦æ­£ç¡®æ›´æ–°

3. **ä½¿ç”¨æµ‹è¯•æ–‡ä»¶**ï¼š
   ```javascript
   // åœ¨å°ç¨‹åºç¯å¢ƒä¸­
   const { testUserUpdate } = require('../utils/userUpdateTest')
   await testUserUpdate.runAllTests()
   ```

## ğŸ“ˆ å…¼å®¹æ€§

âœ… **å‘åå…¼å®¹**: ç°æœ‰çš„ç”¨æˆ·æ›´æ–°åŠŸèƒ½å®Œå…¨ä¿æŒå…¼å®¹  
âœ… **æ–°åŠŸèƒ½å¯é€‰**: `sync_username` å‚æ•°ä¸ºå¯é€‰ï¼Œé»˜è®¤è¡Œä¸ºä¸å˜  
âœ… **æ¸è¿›å¢å¼º**: å¯ä»¥é€æ­¥åœ¨ä¸åŒé¡µé¢å¯ç”¨æ–°åŠŸèƒ½  

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `utils/healingApi.js` - APIæ–¹æ³•æ›´æ–°
- `pages/profile/profile.js` - é¡µé¢é›†æˆ
- `utils/userUpdateExample.js` - ä½¿ç”¨ç¤ºä¾‹
- `utils/userUpdateTest.js` - æµ‹è¯•ç”¨ä¾‹
- `services/AuthService.js` - è®¤è¯æœåŠ¡ï¼ˆå·²æ”¯æŒï¼‰

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

1. **æµ‹è¯•ç¯å¢ƒéªŒè¯**: åœ¨å¼€å‘ç¯å¢ƒä¸­æµ‹è¯•æ‰€æœ‰æ›´æ–°åœºæ™¯
2. **UIä¼˜åŒ–**: è€ƒè™‘ä¸ºè­¦å‘Šä¿¡æ¯æ·»åŠ æ›´å‹å¥½çš„UIç»„ä»¶
3. **æ€§èƒ½ç›‘æ§**: ç›‘æ§æ–°åŠŸèƒ½å¯¹æ€§èƒ½çš„å½±å“
4. **ç”¨æˆ·åé¦ˆ**: æ”¶é›†ç”¨æˆ·å¯¹è‡ªåŠ¨åŒæ­¥åŠŸèƒ½çš„ä½¿ç”¨åé¦ˆ

## âœ… é›†æˆçŠ¶æ€æ€»ç»“

| åŠŸèƒ½æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| UserAPIæ›´æ–° | âœ… å®Œæˆ | æ”¯æŒsync_usernameå‚æ•° |
| Profileé¡µé¢é›†æˆ | âœ… å®Œæˆ | æ˜µç§°æ›´æ–°è‡ªåŠ¨åŒæ­¥ |
| è­¦å‘Šä¿¡æ¯å¤„ç† | âœ… å®Œæˆ | æ¨¡æ€æ¡†æ˜¾ç¤ºè­¦å‘Š |
| ä½¿ç”¨ç¤ºä¾‹ | âœ… å®Œæˆ | å¤šç§ä½¿ç”¨æ–¹å¼ |
| æµ‹è¯•ç”¨ä¾‹ | âœ… å®Œæˆ | éªŒè¯åŠŸèƒ½æ­£å¸¸ |
| æ–‡æ¡£å®Œå–„ | âœ… å®Œæˆ | è¯¦ç»†ä½¿ç”¨è¯´æ˜ |

ğŸ‰ **é›†æˆæˆåŠŸï¼** ç”¨æˆ·ååŒæ­¥åŠŸèƒ½å·²å®Œå…¨é›†æˆåˆ°é¡¹ç›®ä¸­ï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨ã€‚
