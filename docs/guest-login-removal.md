# 游客登录功能移除完整方案

## 概述

应用户要求，已完全移除小程序中的游客登录功能。现在用户必须使用账号密码登录或微信登录才能使用应用。

## 移除原因

- 游客登录功能使用场景有限
- 需要更严格的用户管理和认证
- 简化登录流程，提升用户体验

## 修改内容

### 1. 前端UI层面 ✅

#### 登录页面 (`pages/login/login.wxml`)
- 移除了"游客体验"按钮
- 移除了分隔线UI (`或`)
- 简化了页面布局

#### 样式文件 (`pages/login/login.wxss`)
- 删除了 `.guest-login` 样式
- 删除了 `.divider` 相关样式
- 删除了 `.divider-line` 和 `.divider-text` 样式

#### 登录逻辑 (`pages/login/login.js`)
- 移除了 `onGuestLogin()` 方法
- 更新 `onAccountLogin()` 使用真正的账号密码登录API

### 2. AuthService层面 ✅

#### 新增功能
- **账号密码登录** (`accountLogin(username, password)`)
  - 调用后端 `/auth/account-login` API
  - 完整的认证流程和token管理

#### 移除功能
- **游客登录方法** (`guestLogin()`)
- **自动游客登录回退机制**

#### 更新功能
- **ensureValidToken()** 重构
  - 移除游客登录回退
  - 要求用户登录时抛出明确错误
  - 保留token自动刷新机制

### 3. API层面 ✅

#### healingApi.js修改
- 移除了 `UserAPI.guestLogin()` 方法
- 保留了其他登录方式（微信登录、账号登录）

### 4. 后端API层面 ✅

#### miniprogram_auth.py修改
- 禁用了 `/auth/guest-login` 路由（使用多行注释）
- 保留代码结构以便将来重新启用
- 其他登录API正常工作

## 新的登录流程

### 用户选择
1. **账号密码登录** - 使用注册的用户名/密码
2. **微信登录** - 使用微信授权登录

### 认证机制
1. **无token** → 跳转到登录页面
2. **token过期** → 自动刷新token
3. **刷新失败** → 清除认证信息，要求重新登录

## 影响分析

### 正面影响 ✅
- **更安全的用户管理** - 所有用户都有明确身份
- **简化的登录界面** - 减少用户选择，提升体验
- **一致的用户数据** - 避免游客数据丢失问题
- **更好的功能权限控制** - 基于真实用户身份

### 需要注意的变化 ⚠️
- **强制登录** - 用户必须登录才能使用应用
- **首次使用门槛** - 新用户需要注册或微信授权
- **离线使用** - token过期后需要重新联网登录

## 代码变更清单

### 前端文件
- `pages/login/login.wxml` - 移除游客登录UI
- `pages/login/login.wxss` - 移除相关样式
- `pages/login/login.js` - 移除游客登录方法，更新账号登录
- `services/AuthService.js` - 新增账号登录，移除游客登录，重构ensureValidToken
- `utils/healingApi.js` - 移除游客登录API

### 后端文件
- `routes/miniprogram_auth.py` - 禁用游客登录路由

## 兼容性处理

### 现有的错误处理机制
- `app.js` - 已使用 `.catch(() => null)` 处理ensureValidToken错误
- `pages/profile/profile.js` - 已有微信登录回退机制
- 其他页面会收到明确的登录错误提示

### 数据迁移
- 现有游客用户数据保留在数据库中
- 如需要，可以通过数据库查询识别和处理游客账户

## 测试建议

### 功能测试
1. **账号登录** - 测试正确/错误的用户名密码
2. **微信登录** - 测试微信授权流程
3. **token管理** - 测试自动刷新和过期处理
4. **权限控制** - 验证未登录用户无法访问受保护功能

### 边界测试
1. **网络异常** - 登录请求失败的处理
2. **token过期** - 自动刷新和重新登录流程
3. **用户体验** - 登录失败的错误提示

## 回滚方案

如需要重新启用游客登录功能：

1. **后端** - 取消 `miniprogram_auth.py` 中的多行注释
2. **前端API** - 恢复 `healingApi.js` 中的游客登录方法
3. **AuthService** - 恢复游客登录方法和ensureValidToken回退
4. **UI界面** - 恢复登录页面的游客登录按钮

## 总结

游客登录功能已完全移除，系统现在采用**强制登录**模式。用户必须通过账号密码或微信登录才能使用应用，这提供了更好的安全性和用户管理能力。

所有修改都保持了向后兼容性，现有的用户认证机制和权限控制系统完全正常工作。
