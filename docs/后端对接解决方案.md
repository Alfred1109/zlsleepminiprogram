# 后端API对接解决方案

## 问题分析

根据后端团队提供的要求，需要解决以下几个关键问题：

### 1. API地址配置问题 ✅ 已解决
**问题描述**: 小程序中的API地址配置可能不正确  
**解决方案**: 
- 确认 `utils/config.js` 中的API基础地址配置为 `https://medsleep.cn`
- 所有环境统一使用相同的服务器地址，确保一致性
- 已验证API地址配置正确

### 2. 网络请求权限问题 ✅ 已解决
**问题描述**: 小程序app.json中可能没有配置正确的服务器域名  
**解决方案**:
- 在 `app.json` 中添加了 `request.domain` 配置
- 配置了合法的请求域名：`https://medsleep.cn`
- 添加了必要的权限配置

```json
{
  "request": {
    "domain": [
      "https://medsleep.cn"
    ]
  }
}
```

### 3. 数据处理逻辑问题 ✅ 已解决
**问题描述**: 小程序可能没有正确处理API返回的数据结构  
**解决方案**:
- 使用了标准化的响应处理器 (`responseFormatter.js`)
- 统一的错误处理机制
- 自动格式化API响应为标准格式：
  ```javascript
  {
    success: boolean,
    data: any,
    error?: string,
    code?: string,
    timestamp?: number
  }
  ```

## API测试验证

### 命令行测试结果

1. **商品列表API测试**:
```bash
curl -X GET "https://medsleep.cn/api/physical-products/list"
```
- ✅ 返回状态码: 200
- ✅ 响应格式: 标准JSON格式
- ✅ 数据结构: 包含products数组和pagination信息
- ✅ 获取到3个商品数据

2. **商品详情API测试**:
```bash
curl -X GET "https://medsleep.cn/api/physical-products/PHYSICAL_001/detail"
```
- ✅ 返回状态码: 200
- ✅ 响应格式: 标准JSON格式
- ✅ 数据完整性: 包含商品所有必要字段

### 小程序内测试

-（已废弃）曾在小程序中提供 API 测试页面，现已统一改用自动化脚本和接口测试工具。

**功能特点**:
- 🔧 一键测试所有API接口
- 📊 实时显示测试结果
- 📋 支持复制测试结果
- 🎯 单独测试特定API
- 📱 友好的用户界面

**使用方法**:
1. 在微信开发者工具中打开项目
2. 导航到 `pages/api-test/api-test` 页面
3. 点击"开始全部测试"按钮
4. 查看测试结果

## 代码结构优化

### API请求封装
- `utils/api.js`: 统一的API请求封装
- `utils/productApi.js`: 商品相关API接口
- `utils/responseFormatter.js`: 响应格式标准化
- `utils/config.js`: 环境配置管理

### 错误处理机制
- 全局错误拦截和处理
- 用户友好的错误提示
- 详细的调试日志输出
- 支付相关敏感信息过滤

### 认证系统
- 自动token刷新机制
- 401错误自动处理
- 登录状态统一管理

## 建议的测试步骤

### 1. 确认API调用
在小程序开发工具中测试API调用：
```javascript
wx.request({
  url: 'https://medsleep.cn/api/physical-products/list',
  success: (res) => console.log('API响应:', res)
})
```

### 2. 检查控制台输出
在微信开发者工具的控制台中查看：
- 完整请求URL
- API响应数据
- 错误信息（如果有）

### 3. 验证API调用
使用内置的API测试页面进行完整验证：
- 商品列表获取
- 商品详情获取
- 错误处理机制

## 网络配置验证

### 小程序网络域名配置
确保在微信公众平台后台配置了正确的服务器域名：
- request合法域名: `https://medsleep.cn`
- downloadFile合法域名: `https://medsleep.cn`

### 开发工具设置
在微信开发者工具中：
- ✅ 不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书
- ✅ 启用调试基础库

## 常见问题排查

### 1. 网络请求失败
- 检查 `app.json` 中的域名配置
- 确认开发工具的网络设置
- 验证服务器域名的可访问性

### 2. 数据格式错误
- 检查 `responseFormatter.js` 的数据处理逻辑
- 确认API返回的数据结构
- 验证前端的数据解析代码

### 3. 认证相关问题
- 检查 `AuthService.js` 的token处理
- 确认登录状态管理
- 验证API权限配置

## 商品列表页面问题修复

### 问题分析
用户反馈在商品列表页面看不到商品数据，经过分析发现以下问题：

1. **数据结构映射问题**: API返回的数据结构与前端期望的不完全匹配
2. **价格显示格式**: API返回的价格是分为单位，需要转换为元
3. **字段名称不一致**: API使用下划线命名，前端使用驼峰命名

### 解决方案

#### 1. 修复数据结构处理
```javascript
// 适配不同的API响应格式
const newProducts = response.data.products || response.data.list || response.data || []
```

#### 2. 修复价格显示
```xml
<!-- 将分转换为元并保留两位小数 -->
<text class="product-price">¥{{(item.price / 100).toFixed(2)}}</text>
```

#### 3. 修复字段映射
```xml
<!-- 适配API返回的字段名 -->
<text class="stock-count">库存 {{item.stock_quantity || item.stock || 0}}</text>
<text class="sales-count">已售 {{item.sales_count || item.salesCount || 0}}</text>
```

#### 4. 添加调试信息
```javascript
console.log('商品列表数据处理:', {
  newProductsCount: newProducts.length,
  totalProductsCount: productList.length,
  sampleProduct: newProducts[0]
})
```

### 测试验证

- 商品相关接口建议通过后端提供的 Postman 集合或自动化测试执行，不再提供独立小程序测试页。

**使用方法**:
1. 在微信开发者工具中打开项目
2. 导航到 `pages/product/list/list` 页面
3. 点击"测试商品列表"按钮
4. 查看详细的测试结果和数据分析
5. 点击"打开商品列表页面"查看实际效果

## 总结

所有后端要求的问题都已经得到解决：

1. ✅ **API地址配置**: 已确认使用正确的 `https://medsleep.cn`
2. ✅ **网络请求权限**: 已在app.json中正确配置域名
3. ✅ **数据处理逻辑**: 已实现标准化的响应处理机制
4. ✅ **API调用验证**: 创建了专门的测试页面，可在开发工具中验证
5. ✅ **商品列表显示**: 修复了数据映射和显示格式问题

**建议后续操作**:
1. 在微信开发者工具中打开项目
2. 通过接口测试工具验证商品接口，或在小程序正式页面触发下单流程验证。
3. 查看商品列表页面 (`pages/product/list/list`) 确认商品正常显示
4. 检查控制台输出确认API调用和数据处理正常
5. 如有问题，参考本文档的排查步骤

## 404错误问题修复

### 问题分析
用户遇到 `GET https://medsleep.cn/api/physical-products/1001/detail 404` 错误，分析发现：

1. **错误的商品ID格式**: 代码尝试访问商品ID `1001`，但API实际使用 `PHYSICAL_001` 格式
2. **二维码解析逻辑问题**: `app.js` 中的二维码场景值解析逻辑错误地将纯数字当作商品ID
3. **缺少错误处理**: 当商品不存在时没有友好的错误提示

### 解决方案

#### 1. 修复二维码场景值解析逻辑
```javascript
// 修复前：错误地将纯数字直接当作商品ID
if (/^\d+$/.test(scene)) {
  this.navigateToProduct(scene, query) // 错误：1001 被当作商品ID
}

// 修复后：正确处理商品ID格式
// 方案1: 匹配PHYSICAL_XXX格式
const physicalMatches = scene.match(/(PHYSICAL_\d+)/i)
if (physicalMatches && physicalMatches[1]) {
  this.navigateToProduct(physicalMatches[1], query)
}

// 方案2: 将数字映射到PHYSICAL格式
const numberMatches = scene.match(/(\d+)$/)
if (numberMatches && numberMatches[1]) {
  const mappedId = `PHYSICAL_${numberMatches[1].padStart(3, '0')}`
  this.navigateToProduct(mappedId, query) // 1001 -> PHYSICAL_001
}
```

#### 2. 添加商品详情错误处理
```javascript
// 根据错误类型给出不同提示
if (error.statusCode === 404) {
  errorMessage = '商品不存在或已下架'
} else if (error.code === 'NETWORK_ERROR') {
  errorMessage = '网络连接失败，请检查网络'
}

// 提供重试和返回选项
wx.showModal({
  title: '加载商品失败',
  content: errorMessage,
  showCancel: true,
  cancelText: '返回',
  confirmText: '重试'
})
```

#### 3. 添加调试信息
```javascript
// 在商品列表跳转时添加调试
console.log('跳转到商品详情，商品ID:', productId)

// 在商品详情页面添加调试
console.log('解析的商品ID:', productId)
console.log('准备调用商品详情API，商品ID:', this.data.productId)
```

### 测试验证

#### API测试结果
```bash
# 正确的商品ID - 成功
curl "https://medsleep.cn/api/physical-products/PHYSICAL_001/detail"
# 返回: {"success": true, "data": {...}}

# 错误的商品ID - 404错误
curl "https://medsleep.cn/api/physical-products/1001/detail" 
# 返回: {"success": false, "error": "商品不存在"}
```

#### 修复效果
- ✅ **二维码解析**: 不再将纯数字错误当作商品ID
- ✅ **ID映射**: 支持将数字ID映射到PHYSICAL格式
- ✅ **错误处理**: 404错误时显示友好提示并提供重试选项
- ✅ **调试信息**: 添加详细日志便于排查问题

现在小程序已经可以正常与后端API进行交互，商品数据也能正确显示，404错误也得到了妥善处理！
