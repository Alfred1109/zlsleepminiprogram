# 脑波页面认证时机调整说明

## 调整概述

根据用户要求，将底部导航栏中的"脑波"页面（`pages/music/library/library`）的认证时机调整为：
- **未登录用户可见**：可以查看页面结构和功能介绍
- **登录后才能看到个人内容**：只有登录后才能看到自己的音频库和使用相关功能

## 修改内容

### 1. 页面初始化逻辑调整

**修改前：**
```javascript
onLoad() {
  if (!AuthService.getCurrentUser()) {
    console.log('用户未登录，跳转到登录页')
    wx.navigateTo({ url: '/pages/login/login' })
    return // 强制跳转到登录页
  }
  this.initPage()
}
```

**修改后：**
```javascript
onLoad() {
  console.log('音频库页面加载')
  // 修改：允许未登录用户查看脑波页面，但不强制登录
  this.initPage()
}
```

### 2. 登录检查逻辑优化

**修改前：**
- 未登录时显示强制登录弹窗
- 用户必须登录才能继续使用

**修改后：**
- 未登录时静默处理，显示访客模式
- 不再弹出强制登录的提示

### 3. 新增访客模式支持

**新增功能：**
```javascript
/**
 * 显示访客内容（未登录状态）
 */
showGuestContent() {
  console.log('显示访客内容')
  this.setData({
    musicList: [],
    longSequenceList: [],
    loading: false,
    userInfo: null,
    isGuestMode: true
  })
}
```

### 4. 页面状态管理

**新增数据字段：**
```javascript
data: {
  isGuestMode: false, // 新增：是否为访客模式
  // ... 其他字段
}
```

### 5. 用户界面调整

**60秒音频空状态：**
```xml
<!-- 根据登录状态显示不同内容 -->
<view wx:if="{{isGuestMode}}" class="empty-text">请先登录查看您的音频</view>
<view wx:else class="empty-text">暂无音频</view>

<view wx:if="{{isGuestMode}}" class="empty-desc">登录后可查看您生成的专属疗愈音频</view>
<view wx:else class="empty-desc">快去生成您的专属疗愈音频吧</view>

<button wx:if="{{isGuestMode}}" class="btn-primary" bindtap="promptLogin">去登录</button>
<button wx:else class="btn-primary" bindtap="onGoToGenerate">生成音频</button>
```

**长序列音频空状态：**
```xml
<!-- 类似的条件显示逻辑 -->
<view wx:if="{{isGuestMode}}" class="empty-text">请先登录查看您的长序列音频</view>
<view wx:else class="empty-text">暂无长序列音频</view>

<button wx:if="{{isGuestMode}}" class="btn-primary" bindtap="promptLogin">去登录</button>
<button wx:else class="btn-primary" bindtap="onGoToCreateSequence">创建长序列</button>
```

### 6. 登录引导优化

**修改前：**
- 强制性的登录弹窗
- 用户只能选择登录或返回首页

**修改后：**
```javascript
promptLogin(message = '查看个人音频库需要先登录账户') {
  wx.showModal({
    title: '需要登录',
    content: message,
    confirmText: '去登录',
    cancelText: '取消',
    success: (res) => {
      if (res.confirm) {
        wx.navigateTo({
          url: '/pages/login/login?redirect=' + encodeURIComponent('/pages/music/library/library')
        })
      }
    }
  })
}
```

## 用户体验改进

### 1. 访问体验
- ✅ **先可见**：未登录用户可以查看脑波页面的结构和布局
- ✅ **再可用**：登录后才能看到个人音频库和使用功能
- ✅ **友好引导**：提供清晰的登录引导，不强制用户

### 2. 状态区分
- ✅ **访客模式**：显示"请先登录查看您的音频"等引导信息
- ✅ **用户模式**：显示个人音频库和完整功能
- ✅ **状态切换**：登录状态变化时自动更新页面内容

### 3. 功能引导
- ✅ **明确提示**：告知用户登录后可以使用的功能
- ✅ **操作便利**：一键跳转到登录页面
- ✅ **回流机制**：登录成功后自动返回脑波页面

## 修改的文件

1. **`pages/music/library/library.js`**
   - 修改页面初始化逻辑
   - 新增访客模式支持
   - 优化登录检查和引导逻辑

2. **`pages/music/library/library.wxml`**
   - 添加访客模式的条件显示
   - 优化空状态的用户引导

## 测试验证

### 测试场景：
1. **未登录用户访问脑波页面**
   - 可以正常进入页面 ✓
   - 显示访客模式的空状态 ✓
   - 提供友好的登录引导 ✓

2. **已登录用户访问脑波页面**
   - 显示个人音频库 ✓
   - 可以正常使用所有功能 ✓
   - 订阅状态正确显示 ✓

3. **登录状态切换**
   - 从未登录变为已登录时页面自动更新 ✓
   - 从已登录变为未登录时显示访客模式 ✓

## 总结

通过这次调整，脑波页面现在完全符合"先可见，再可用时登录"的微信小程序规范：

1. **用户体验统一**：与首页的评测和脑波生成页面保持一致的认证时机
2. **访问门槛降低**：用户可以先了解功能，再决定是否登录
3. **引导更友好**：不强制登录，提供清晰的功能说明和登录引导
4. **功能完整性**：登录后可以使用完整的个人音频库功能

现在整个应用的认证时机都统一了：用户可以先浏览和了解功能，在真正需要使用个人化功能时才要求登录。
